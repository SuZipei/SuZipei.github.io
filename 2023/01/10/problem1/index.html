

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Su_Zipei">
  <meta name="keywords" content="">
  
    <meta name="description" content="凌乱平衡树 给定两棵 $Treap$，每次将某棵树上的某个点 $rotate$，然后将两棵树合并，询问每次合并后所有点的深度和 。  首先深度和显然可以先一遍 $dfs$ 处理出来，然后计算两棵树原来的深度和，之后在合并的时候计算额外的贡献即可 。 在合并的时候只有左侧树的右链和右侧树的左链有用，所以只需要维护这两个链即可，那么本质上是序列的问题，考虑一次合并的时候，如果当前左侧点对应的子树大小为">
<meta property="og:type" content="article">
<meta property="og:title" content="杂题选做">
<meta property="og:url" content="https://suzipei.github.io/2023/01/10/problem1/index.html">
<meta property="og:site_name" content="苏子佩のBlog">
<meta property="og:description" content="凌乱平衡树 给定两棵 $Treap$，每次将某棵树上的某个点 $rotate$，然后将两棵树合并，询问每次合并后所有点的深度和 。  首先深度和显然可以先一遍 $dfs$ 处理出来，然后计算两棵树原来的深度和，之后在合并的时候计算额外的贡献即可 。 在合并的时候只有左侧树的右链和右侧树的左链有用，所以只需要维护这两个链即可，那么本质上是序列的问题，考虑一次合并的时候，如果当前左侧点对应的子树大小为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://suzipei.github.io/img/ashe.png">
<meta property="article:published_time" content="2023-01-10T14:21:14.000Z">
<meta property="article:modified_time" content="2023-01-22T02:29:09.256Z">
<meta property="article:author" content="Su_Zipei">
<meta property="article:tag" content="杂题">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://suzipei.github.io/img/ashe.png">
  
  
  
  <title>杂题选做 - 苏子佩のBlog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"suzipei.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>苏子佩のBlog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="杂题选做"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-01-10 22:21" pubdate>
          2023年1月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          80k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          668 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">杂题选做</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="凌乱平衡树"><a href="#凌乱平衡树" class="headerlink" title="凌乱平衡树"></a>凌乱平衡树</h1><blockquote>
<p>给定两棵 $Treap$，每次将某棵树上的某个点 $rotate$，然后将两棵树合并，询问每次合并后所有点的深度和 。</p>
</blockquote>
<p>首先深度和显然可以先一遍 $dfs$ 处理出来，然后计算两棵树原来的深度和，之后在合并的时候计算额外的贡献即可 。</p>
<p>在合并的时候只有左侧树的右链和右侧树的左链有用，所以只需要维护这两个链即可，那么本质上是序列的问题，考虑一次合并的时候，如果当前左侧点对应的子树大小为 $siz_1$ ，右侧子树大小为 $siz_2$，那么如果将左侧子树作为根，那么答案加上 $siz_2$ 否则答案加上 $siz_1$，所以只需要考虑当前点贡献多少次即可，不难发现贡献是一个区间的形式，所以直接用线段树维护 。</p>
<p>注意几点:</p>
<ul>
<li>旋转时记得修改原来树的贡献</li>
<li>修改关键链上的点对应线段树的权值</li>
<li>修改贡献后记得考虑下一个点的修改</li>
<li>极大值要设置的大一些</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span>+<span class="hljs-number">10</span>;<br>ll res;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Treap</span>&#123;<br>	<span class="hljs-type">int</span> n,rt,ch[N][<span class="hljs-number">2</span>],fa[N],siz[N];<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint u)</span></span>&#123;<br>		<span class="hljs-keyword">if</span>(!u)<span class="hljs-keyword">return</span> ;<br>		<span class="hljs-built_in">dfs</span>(ch[u][<span class="hljs-number">0</span>]);<br>		<span class="hljs-built_in">dfs</span>(ch[u][<span class="hljs-number">1</span>]);<br>		siz[u]=siz[ch[u][<span class="hljs-number">0</span>]]+siz[ch[u][<span class="hljs-number">1</span>]]+<span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;ch[i][<span class="hljs-number">0</span>],&amp;ch[i][<span class="hljs-number">1</span>]);<br>			fa[ch[i][<span class="hljs-number">0</span>]]=fa[ch[i][<span class="hljs-number">1</span>]]=i;<br>		&#125;<br>		rt=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">while</span>(fa[rt])rt=fa[rt];<br>		<span class="hljs-built_in">dfs</span>(rt);<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>			res+=siz[i];<br>	&#125;<br>&#125;t1,t2;<br>set&lt;<span class="hljs-type">int</span>&gt; s1,s2;<br><span class="hljs-type">int</span> val1[N&lt;&lt;<span class="hljs-number">2</span>],val2[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update1</span><span class="hljs-params">(rint rt,rint l,rint r,rint pos,rint v)</span></span>&#123;<br>	val1[rt]+=v;<br>	<span class="hljs-keyword">if</span>(l==r)<span class="hljs-keyword">return</span> ;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(pos&lt;=mid)<span class="hljs-built_in">update1</span>(rt&lt;&lt;<span class="hljs-number">1</span>,l,mid,pos,v);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">update1</span>(rt&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r,pos,v);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update2</span><span class="hljs-params">(rint rt,rint l,rint r,rint pos,rint v)</span></span>&#123;<br>	val2[rt]+=v;<br>	<span class="hljs-keyword">if</span>(l==r)<span class="hljs-keyword">return</span> ;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(pos&lt;=mid)<span class="hljs-built_in">update2</span>(rt&lt;&lt;<span class="hljs-number">1</span>,l,mid,pos,v);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">update2</span>(rt&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r,pos,v);<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">query1</span><span class="hljs-params">(rint rt,rint l,rint r,rint cl,rint cr)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(!val1[rt])<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=l&amp;&amp;r&lt;=cr)<span class="hljs-keyword">return</span> val1[rt];<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=mid)res+=<span class="hljs-built_in">query1</span>(rt&lt;&lt;<span class="hljs-number">1</span>,l,mid,cl,cr);<br>	<span class="hljs-keyword">if</span>(cr&gt;mid)res+=<span class="hljs-built_in">query1</span>(rt&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r,cl,cr);<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">query2</span><span class="hljs-params">(rint rt,rint l,rint r,rint cl,rint cr)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(!val2[rt])<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=l&amp;&amp;r&lt;=cr)<span class="hljs-keyword">return</span> val2[rt];<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=mid)res+=<span class="hljs-built_in">query2</span>(rt&lt;&lt;<span class="hljs-number">1</span>,l,mid,cl,cr);<br>	<span class="hljs-keyword">if</span>(cr&gt;mid)res+=<span class="hljs-built_in">query2</span>(rt&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r,cl,cr);<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-type">bool</span> vis1[N],vis2[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rotate1</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	rint y=t1.fa[x];rint z=t1.fa[y];<br>	res-=t1.siz[y];res-=t1.siz[x];<br>	<span class="hljs-keyword">if</span>(vis1[y])&#123;<br>		<span class="hljs-built_in">update1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t1.siz[y],<span class="hljs-number">-1</span>);<br>		rll val=<span class="hljs-built_in">query2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t1.siz[y]+<span class="hljs-number">1</span>,*s1.<span class="hljs-built_in">upper_bound</span>(t1.siz[y]));<br>		res-=t1.siz[y]*val;<br>		res+=(*--s1.<span class="hljs-built_in">find</span>(t1.siz[y]))*val;<br>		res-=*--s2.<span class="hljs-built_in">upper_bound</span>(t1.siz[y]);<br>		s1.<span class="hljs-built_in">erase</span>(t1.siz[y]);<br>		<span class="hljs-keyword">if</span>(vis1[x])&#123;<br>			<span class="hljs-built_in">update1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t1.siz[x],<span class="hljs-number">-1</span>);<br>			val=<span class="hljs-built_in">query2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t1.siz[x]+<span class="hljs-number">1</span>,*s1.<span class="hljs-built_in">upper_bound</span>(t1.siz[x]));<br>			res-=t1.siz[x]*val;<br>			res+=(*--s1.<span class="hljs-built_in">find</span>(t1.siz[x]))*val;<br>			res-=*--s2.<span class="hljs-built_in">upper_bound</span>(t1.siz[x]);<br>			s1.<span class="hljs-built_in">erase</span>(t1.siz[x]);<br>		&#125;<br>	&#125;<br>	rint k=t1.ch[y][<span class="hljs-number">1</span>]==x;<br>	t1.ch[z][t1.ch[z][<span class="hljs-number">1</span>]==y]=x;t1.fa[x]=z;<br>	t1.ch[y][k]=t1.ch[x][!k];t1.fa[t1.ch[x][!k]]=y;<br>	t1.ch[x][!k]=y;t1.fa[y]=x;<br>	t1.siz[y]=t1.siz[t1.ch[y][<span class="hljs-number">0</span>]]+t1.siz[t1.ch[y][<span class="hljs-number">1</span>]]+<span class="hljs-number">1</span>;<br>	t1.siz[x]=t1.siz[t1.ch[x][<span class="hljs-number">0</span>]]+t1.siz[t1.ch[x][<span class="hljs-number">1</span>]]+<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(vis1[y])&#123;<br>		<span class="hljs-built_in">update1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t1.siz[x],<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">if</span>(vis1[x])&#123;<br>			s1.<span class="hljs-built_in">insert</span>(t1.siz[x]);<br>			vis1[y]=<span class="hljs-number">0</span>;<br>			rll val=<span class="hljs-built_in">query2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t1.siz[x]+<span class="hljs-number">1</span>,*s1.<span class="hljs-built_in">upper_bound</span>(t1.siz[x]));<br>			res+=t1.siz[x]*val;<br>			res-=(*--s1.<span class="hljs-built_in">find</span>(t1.siz[x]))*val;<br>			res+=*--s2.<span class="hljs-built_in">upper_bound</span>(t1.siz[x]);<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			s1.<span class="hljs-built_in">insert</span>(t1.siz[y]);<br>			rll val=<span class="hljs-built_in">query2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t1.siz[y]+<span class="hljs-number">1</span>,*s1.<span class="hljs-built_in">upper_bound</span>(t1.siz[y]));<br>			res+=t1.siz[y]*val;<br>			res-=(*--s1.<span class="hljs-built_in">find</span>(t1.siz[y]))*val;<br>			res+=*--s2.<span class="hljs-built_in">upper_bound</span>(t1.siz[y]);<br>			s1.<span class="hljs-built_in">insert</span>(t1.siz[x]);<br>			val=<span class="hljs-built_in">query2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t1.siz[x]+<span class="hljs-number">1</span>,*s1.<span class="hljs-built_in">upper_bound</span>(t1.siz[x]));<br>			res+=t1.siz[x]*val;<br>			res-=(*--s1.<span class="hljs-built_in">find</span>(t1.siz[x]))*val;<br>			res+=*--s2.<span class="hljs-built_in">upper_bound</span>(t1.siz[x]);<br>			vis1[x]=<span class="hljs-number">1</span>;<br>			<span class="hljs-built_in">update1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t1.siz[y],<span class="hljs-number">1</span>);<br>		&#125;<br>	&#125;<br>	res+=t1.siz[y];res+=t1.siz[x];<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rotate2</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	rint y=t2.fa[x];rint z=t2.fa[y];<br>	res-=t2.siz[y];res-=t2.siz[x];<br>	<span class="hljs-keyword">if</span>(vis2[y])&#123;<br>		<span class="hljs-built_in">update2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t2.siz[y],<span class="hljs-number">-1</span>);<br>		rll val=<span class="hljs-built_in">query1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t2.siz[y],*s2.<span class="hljs-built_in">upper_bound</span>(t2.siz[y])<span class="hljs-number">-1</span>);<br>		res-=t2.siz[y]*val;<br>		res+=(*--s2.<span class="hljs-built_in">find</span>(t2.siz[y]))*val;<br>		res-=*--s1.<span class="hljs-built_in">lower_bound</span>(t2.siz[y]);<br>		s2.<span class="hljs-built_in">erase</span>(t2.siz[y]);<br>		<span class="hljs-keyword">if</span>(vis2[x])&#123;<br>			<span class="hljs-built_in">update2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t2.siz[x],<span class="hljs-number">-1</span>);<br>			val=<span class="hljs-built_in">query1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t2.siz[x],*s2.<span class="hljs-built_in">upper_bound</span>(t2.siz[x])<span class="hljs-number">-1</span>);<br>			res-=t2.siz[x]*val;<br>			res+=(*--s2.<span class="hljs-built_in">find</span>(t2.siz[x]))*val;<br>			res-=*--s1.<span class="hljs-built_in">lower_bound</span>(t2.siz[x]);<br>			s2.<span class="hljs-built_in">erase</span>(t2.siz[x]);<br>		&#125;<br>	&#125;<br>	rint k=t2.ch[y][<span class="hljs-number">1</span>]==x;<br>	t2.ch[z][t2.ch[z][<span class="hljs-number">1</span>]==y]=x;t2.fa[x]=z;<br>	t2.ch[y][k]=t2.ch[x][!k];t2.fa[t2.ch[x][!k]]=y;<br>	t2.ch[x][!k]=y;t2.fa[y]=x;<br>	t2.siz[y]=t2.siz[t2.ch[y][<span class="hljs-number">0</span>]]+t2.siz[t2.ch[y][<span class="hljs-number">1</span>]]+<span class="hljs-number">1</span>;<br>	t2.siz[x]=t2.siz[t2.ch[x][<span class="hljs-number">0</span>]]+t2.siz[t2.ch[x][<span class="hljs-number">1</span>]]+<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(vis2[y])&#123;<br>		<span class="hljs-built_in">update2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t2.siz[x],<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">if</span>(vis2[x])&#123;<br>			s2.<span class="hljs-built_in">insert</span>(t2.siz[x]);<br>			vis2[y]=<span class="hljs-number">0</span>;<br>			rll val=<span class="hljs-built_in">query1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t2.siz[x],*s2.<span class="hljs-built_in">upper_bound</span>(t2.siz[x])<span class="hljs-number">-1</span>);<br>			res+=t2.siz[x]*val;<br>			res-=(*--s2.<span class="hljs-built_in">find</span>(t2.siz[x]))*val;<br>			res+=*--s1.<span class="hljs-built_in">lower_bound</span>(t2.siz[x]);<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-built_in">update2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t2.siz[y],<span class="hljs-number">1</span>);<br>			s2.<span class="hljs-built_in">insert</span>(t2.siz[y]);<br>			rll val=<span class="hljs-built_in">query1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t2.siz[y],*s2.<span class="hljs-built_in">upper_bound</span>(t2.siz[y])<span class="hljs-number">-1</span>);<br>			res+=t2.siz[y]*val;<br>			res-=(*--s2.<span class="hljs-built_in">find</span>(t2.siz[y]))*val;<br>			res+=*--s1.<span class="hljs-built_in">lower_bound</span>(t2.siz[y]);<br>			s2.<span class="hljs-built_in">insert</span>(t2.siz[x]);<br>			val=<span class="hljs-built_in">query1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t2.siz[x],*s2.<span class="hljs-built_in">upper_bound</span>(t2.siz[x])<span class="hljs-number">-1</span>);<br>			res+=t2.siz[x]*val;<br>			res-=(*--s2.<span class="hljs-built_in">find</span>(t2.siz[x]))*val;<br>			res+=*--s1.<span class="hljs-built_in">lower_bound</span>(t2.siz[x]);<br>			vis2[x]=<span class="hljs-number">1</span>;<br>		&#125;<br>	&#125;<br>	res+=t2.siz[y];res+=t2.siz[x];<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;t1.n,&amp;t2.n);<br>	t1.<span class="hljs-built_in">init</span>();t2.<span class="hljs-built_in">init</span>();<br>	s1.<span class="hljs-built_in">insert</span>(<span class="hljs-number">0</span>);s2.<span class="hljs-built_in">insert</span>(<span class="hljs-number">0</span>);<br>	s1.<span class="hljs-built_in">insert</span>(<span class="hljs-number">2e5</span>+<span class="hljs-number">2</span>);s2.<span class="hljs-built_in">insert</span>(<span class="hljs-number">2e5</span>+<span class="hljs-number">2</span>);<br>	<span class="hljs-keyword">for</span>(rint x=t1.rt;x;x=t1.ch[x][<span class="hljs-number">1</span>])<br>		s1.<span class="hljs-built_in">insert</span>(t1.siz[x]),<span class="hljs-built_in">update1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,t1.siz[x],<span class="hljs-number">1</span>),vis1[x]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint x=t2.rt;x;x=t2.ch[x][<span class="hljs-number">0</span>])<br>		s2.<span class="hljs-built_in">insert</span>(t2.siz[x]),<span class="hljs-built_in">update2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,t2.siz[x],<span class="hljs-number">1</span>),vis2[x]=<span class="hljs-number">1</span>;<br>	rint lst=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(set&lt;<span class="hljs-type">int</span>&gt;::reverse_iterator it=s1.<span class="hljs-built_in">rbegin</span>();it!=s1.<span class="hljs-built_in">rend</span>();it++)&#123;<br>		rint v=*it;<br>		<span class="hljs-keyword">if</span>(lst&amp;&amp;v)<br>			res+=<span class="hljs-number">1ll</span>*v*<span class="hljs-built_in">query2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t2.n,v+<span class="hljs-number">1</span>,lst);<br>		lst=v;<br>	&#125;<br>	lst=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(set&lt;<span class="hljs-type">int</span>&gt;::reverse_iterator it=s2.<span class="hljs-built_in">rbegin</span>();it!=s2.<span class="hljs-built_in">rend</span>();it++)&#123;<br>		rint v=*it;<br>		<span class="hljs-keyword">if</span>(lst&amp;&amp;v)<br>			res+=<span class="hljs-number">1ll</span>*v*<span class="hljs-built_in">query1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,t1.n,v,lst<span class="hljs-number">-1</span>);<br>		lst=v;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	rint q;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	<span class="hljs-keyword">while</span>(q--)&#123;<br>		rint op,x;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;op,&amp;x);<br>		<span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>)<span class="hljs-built_in">rotate1</span>(x);<br>		<span class="hljs-keyword">else</span> <span class="hljs-built_in">rotate2</span>(x);<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="西克"><a href="#西克" class="headerlink" title="西克"></a>西克</h1><blockquote>
<p>给定一棵树，树上每个点有两个权值，$a,b$ 表示如果走到这个点，手里拿的球是 $a$，那么手中的球会变成 $b$，询问从 $x$ 到 $y$，手中拿着的球是 $b_x$，到达 $y$ 时手里拿的球是什么。</p>
</blockquote>
<p>考虑将路径分成两部分，一部分是从 $x$ 到 $lca$，另一部分是从 $lca$ 到 $y$，前半部分可以直接用倍增的做法，考虑后半部分怎么做，发现没有办法向下走，主要原因是向下走的路径太多，没办法维护，注意到从 $y$ 到 $lca$ 的路径可以被分成不超过 $\log$ 段重链，所以可以对于每一段重链预处理一下，然后倍增跳即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-type">char</span> buf[<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>],*p1,*p2;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">gc</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">return</span> p1==p2?p2=buf+<span class="hljs-built_in">fread</span>(p1=buf,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>,stdin),p1==p2?EOF:*p1++:*p1++;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>&#123;<br>	rint x=<span class="hljs-number">0</span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-string">&#x27;0&#x27;</span>||ch&gt;<span class="hljs-string">&#x27;9&#x27;</span>)ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;ch&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)x=x*<span class="hljs-number">10</span>+ch-<span class="hljs-string">&#x27;0&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e6</span>+<span class="hljs-number">10</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;&#125;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> S1,S2;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">rnd</span><span class="hljs-params">()</span></span>&#123;<br>	S1*=S2,S2&gt;&gt;=S1&amp;<span class="hljs-number">13</span>,S2-=S1,S1^=S2;<br>	<span class="hljs-keyword">return</span> ((S1-S2)&amp;(S1+S2))^(S1*S2&gt;&gt;<span class="hljs-number">4</span>);<br>&#125;<br><span class="hljs-type">int</span> a[N],b[N],p[N][<span class="hljs-number">23</span>],fa[N],d[N],lst[N],siz[N],son[N],dfn[N],Time,rk[N],tp[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs1</span><span class="hljs-params">(rint u)</span></span>&#123;<br>	p[u][<span class="hljs-number">0</span>]=lst[b[u]];<br>	rint t=lst[a[u]];<br>	lst[a[u]]=u;<br>	siz[u]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;p[u][i];i++)<br>		p[u][i+<span class="hljs-number">1</span>]=p[p[u][i]][i];<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa[u])<span class="hljs-keyword">continue</span>;<br>		fa[v]=u;<br>		d[v]=d[u]+<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">dfs1</span>(v);<br>		siz[u]+=siz[v];<br>		<span class="hljs-keyword">if</span>(siz[v]&gt;siz[son[u]])<br>			son[u]=v;<br>	&#125;<br>	lst[a[u]]=t;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(rint u,rint t)</span></span>&#123;<br>	tp[u]=t;dfn[u]=++Time;rk[Time]=u;<br>	<span class="hljs-keyword">if</span>(son[u])<br>		<span class="hljs-built_in">dfs2</span>(son[u],t);<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa[u]||v==son[u])<span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">dfs2</span>(v,v);<br>	&#125;<br>&#125;<br>vector&lt;<span class="hljs-type">int</span>&gt; vec[N];<br><span class="hljs-type">int</span> nxt[N][<span class="hljs-number">22</span>],stk[N],top;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">getlca</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;<br>	top=<span class="hljs-number">0</span>;stk[++top]=y;<br>	<span class="hljs-keyword">while</span>(tp[x]!=tp[y])&#123;<br>		<span class="hljs-keyword">if</span>(d[tp[x]]&gt;d[tp[y]])&#123;<br>			x=fa[tp[x]];<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			y=fa[tp[y]];<br>			stk[++top]=y;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> d[x]&gt;d[y]?y:x;<br>&#125;<br>vector&lt;<span class="hljs-type">int</span>&gt;::iterator it;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">getnxt</span><span class="hljs-params">(rint x,rint l,rint r)</span></span>&#123;<br>	it=<span class="hljs-built_in">lower_bound</span>(vec[x].<span class="hljs-built_in">begin</span>(),vec[x].<span class="hljs-built_in">end</span>(),l);<br>	<span class="hljs-keyword">if</span>(it==vec[x].<span class="hljs-built_in">end</span>())<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	<span class="hljs-keyword">if</span>(*it&gt;r)<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	<span class="hljs-keyword">return</span> rk[*it];<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n=<span class="hljs-built_in">read</span>(),q=<span class="hljs-built_in">read</span>();<br>	S1=<span class="hljs-built_in">read</span>(),S2=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">if</span>(n&lt;=<span class="hljs-number">5e5</span>)&#123;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>			a[i]=<span class="hljs-built_in">read</span>(),b[i]=<span class="hljs-built_in">read</span>();<br>	&#125;<span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">5e5</span>;i++)<br>			a[i]=<span class="hljs-built_in">read</span>(),b[i]=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">500001</span>;i&lt;=n;i++)&#123;<br>			a[i]=<span class="hljs-built_in">rnd</span>()%n+<span class="hljs-number">1</span>;b[i]=a[<span class="hljs-built_in">rnd</span>()%<span class="hljs-number">500000</span>+<span class="hljs-number">1</span>];<br>			<span class="hljs-keyword">if</span>(a[i]==b[i])&#123;<br>				++a[i];<br>				<span class="hljs-keyword">if</span>(a[i]&gt;n)a[i]=<span class="hljs-number">1</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		rint x=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-built_in">Ins</span>(x,i);<br>	&#125;<br>	<span class="hljs-built_in">dfs1</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		vec[a[rk[i]]].<span class="hljs-built_in">push_back</span>(i);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		<span class="hljs-keyword">if</span>(tp[i]==i)&#123;<br>			rint cr=dfn[i];<br>			<span class="hljs-keyword">while</span>(tp[rk[cr+<span class="hljs-number">1</span>]]==i)cr++;<br>			<span class="hljs-keyword">for</span>(rint j=cr;j&gt;=dfn[i];j--)&#123;<br>				rint x=rk[j];<br>				nxt[x][<span class="hljs-number">0</span>]=lst[b[x]];<br>				<span class="hljs-keyword">for</span>(rint k=<span class="hljs-number">0</span>;nxt[x][k];k++)<br>					nxt[x][k+<span class="hljs-number">1</span>]=nxt[nxt[x][k]][k];<br>				lst[a[x]]=x;<br>			&#125;<br>			<span class="hljs-keyword">for</span>(rint j=dfn[i];j&lt;=cr;j++)<br>				lst[a[rk[j]]]=<span class="hljs-number">0</span>;<br>		&#125;<br>	&#125;<br>	rint res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(q--)&#123;<br>		rint x=<span class="hljs-built_in">read</span>(),y=<span class="hljs-built_in">read</span>();<br>		rint lc=<span class="hljs-built_in">getlca</span>(x,y);<br>		rint now=x;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">20</span>;~i;i--)<br>			<span class="hljs-keyword">if</span>(p[now][i]&amp;&amp;d[p[now][i]]&gt;=d[lc])<br>				now=p[now][i];<br>		now=b[now];<br>		rint pos=lc;<br>		<span class="hljs-keyword">for</span>(rint i=top;i;i--)&#123;<br>			rint t=<span class="hljs-built_in">getnxt</span>(now,dfn[pos],dfn[stk[i]]);<br>			<span class="hljs-keyword">if</span>(t!=<span class="hljs-number">-1</span>)&#123;<br>				<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">20</span>;~j;j--)<br>					<span class="hljs-keyword">while</span>(nxt[t][j]&amp;&amp;dfn[nxt[t][j]]&lt;=dfn[stk[i]])<br>						t=nxt[t][j];<br>				now=b[t];<br>			&#125;<br>			pos=tp[stk[i<span class="hljs-number">-1</span>]];<br>		&#125;<br>		res^=now;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,res);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="苯为"><a href="#苯为" class="headerlink" title="苯为"></a>苯为</h1><blockquote>
<p>有一棵树，复制 $A$ 份形成一个森林，枚举一个二元组 $(s,t)$，然后对于相邻的两棵树链接 $s$ 和 $t$，之后用 $k$ 种颜色给形成的基环树进行染色，问染色的方案 。</p>
</blockquote>
<p>不难发现最终的答案只和环的大小有关系，除了环以外别的点的贡献都是 $k-1$，所以只需要对于每个环进行处理即可，用换根 $dp$ 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e6</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">421969921</span>;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>&#123;<br>	rint x=<span class="hljs-number">0</span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-string">&#x27;0&#x27;</span>||ch&gt;<span class="hljs-string">&#x27;9&#x27;</span>)ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;ch&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)x=x*<span class="hljs-number">10</span>+ch-<span class="hljs-string">&#x27;0&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Add</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x+=y;<span class="hljs-keyword">return</span> x&gt;=p?x-p:x;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Del</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x-=y;<span class="hljs-keyword">return</span> x&gt;=<span class="hljs-number">0</span>?x:x+p;&#125;<br><span class="hljs-function">ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Mat</span>&#123;<br>	<span class="hljs-type">int</span> x[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>];<br>	Mat <span class="hljs-keyword">operator</span> * (<span class="hljs-type">const</span> Mat&amp;A)<span class="hljs-type">const</span>&#123;<br>		Mat res;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++)&#123;<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">2</span>;j++)&#123;<br>				rll tmp=<span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">for</span>(rint k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">2</span>;k++)<br>					tmp+=<span class="hljs-number">1ll</span>*x[i][k]*A.x[k][j]%p;<br>				res.x[i][j]=tmp%p;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	Mat <span class="hljs-keyword">operator</span> + (<span class="hljs-type">const</span> Mat&amp;A)<span class="hljs-type">const</span>&#123;<br>		Mat res;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++)<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">2</span>;j++)<br>				res.x[i][j]=<span class="hljs-built_in">Add</span>(x[i][j],A.x[i][j]);<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	Mat <span class="hljs-keyword">operator</span> - (<span class="hljs-type">const</span> Mat&amp;A)<span class="hljs-type">const</span>&#123;<br>		Mat res;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++)<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">2</span>;j++)<br>				res.x[i][j]=<span class="hljs-built_in">Del</span>(x[i][j],A.x[i][j]);<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	Mat <span class="hljs-keyword">operator</span> ^ (<span class="hljs-type">const</span> ll&amp;A)<span class="hljs-type">const</span>&#123;<br>		Mat res,a=*<span class="hljs-keyword">this</span>;<br>		rll k=A;<br>		res.x[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=res.x[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>		res.x[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]=res.x[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">while</span>(k)&#123;<br>			<span class="hljs-keyword">if</span>(k&amp;<span class="hljs-number">1</span>)res=res*a;<br>			a=a*a;<br>			k&gt;&gt;=<span class="hljs-number">1</span>;<br>		&#125;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span>&#123;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++,<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>))<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">2</span>;j++)<br>				<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>,x[i][j]);<br>	&#125;<br>&#125;f[N],g[N],I,m1,m2;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;<br>	e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs1</span><span class="hljs-params">(rint u,rint fa)</span></span>&#123;<br>	f[u]=I;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa)<span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">dfs1</span>(v,u);<br>		f[u]=f[u]+f[v]*m1;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(rint u,rint fa)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa)<span class="hljs-keyword">continue</span>;<br>		g[v]=(g[u]-f[v]*m1)*m1+f[v];<br>		<span class="hljs-built_in">dfs2</span>(v,u);<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	I.x[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=I.x[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	rint n=<span class="hljs-built_in">read</span>();<br>	rll A,k;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%lld%lld&quot;</span>,&amp;A,&amp;k);k%=p;++A;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		rint x=<span class="hljs-built_in">read</span>(),y=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-built_in">Ins</span>(x,y);<span class="hljs-built_in">Ins</span>(y,x);<br>	&#125;<br>	rll fac=<span class="hljs-built_in">fpow</span>(<span class="hljs-built_in">fpow</span>(k<span class="hljs-number">-1</span>,n),A);<br>	rll inv=<span class="hljs-built_in">fpow</span>(<span class="hljs-built_in">fpow</span>(k<span class="hljs-number">-1</span>,p<span class="hljs-number">-2</span>),A);<br>	m1.x[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-built_in">Del</span>(k,<span class="hljs-number">2</span>)*<span class="hljs-built_in">fpow</span>(k<span class="hljs-number">-1</span>,p<span class="hljs-number">-2</span>)%p;<br>	m1.x[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]=<span class="hljs-built_in">Del</span>(k,<span class="hljs-number">1</span>)*<span class="hljs-built_in">fpow</span>(k<span class="hljs-number">-1</span>,p<span class="hljs-number">-2</span>)%p;<br>	m1.x[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]=<span class="hljs-built_in">fpow</span>(k<span class="hljs-number">-1</span>,p<span class="hljs-number">-2</span>);<br>	m1.x[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]=<span class="hljs-number">0</span>;<br>	m2=m1;<br>	<span class="hljs-keyword">for</span>(rll t=A<span class="hljs-number">-1</span>;t;t&gt;&gt;=<span class="hljs-number">1</span>)&#123;<br>		<span class="hljs-keyword">if</span>(t&amp;<span class="hljs-number">1</span>)m2=m2*m1;<br>		m1=m1*m1;<br>	&#125;<br>	m1=m2;<br>	<span class="hljs-built_in">dfs1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	g[<span class="hljs-number">1</span>]=f[<span class="hljs-number">1</span>];<br>	<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	Mat res;<br>	<span class="hljs-built_in">memset</span>(res.x,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(res.x));<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		res=res+g[i];<br>	m1.x[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-built_in">Del</span>(k,<span class="hljs-number">2</span>);<br>	m1.x[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]=<span class="hljs-built_in">Del</span>(k,<span class="hljs-number">1</span>);<br>	m1.x[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	m1.x[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]=<span class="hljs-number">0</span>;<br>	res=res*(m1^(A<span class="hljs-number">-1</span>));<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res.x[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]%p*inv%p*fac%p*k%p);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="正方形"><a href="#正方形" class="headerlink" title="正方形"></a>正方形</h1><blockquote>
<p>给定一张有障碍的网格图，给出一个初始的正方形，要求只上下左右平移并且不碰触障碍，询问能不能到达终点。</p>
</blockquote>
<p>考虑左下角的路径，这个正方形可以通过某个点当且仅当以这个点为左下角的最大正方形的边长不小于给定正方形，所以考虑网格上两个点形成的边，一条边有贡献当且仅当两个格子都满足上述限制，所以直接离线然后排序即可，注意一个小细节，即对于每个点判断初始时会不会被挡住。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e3</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">char</span> s[N];<br><span class="hljs-type">int</span> f[N][N],fa[N*N],idx[N][N],cnt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> id,x,y,xx,yy,w;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (<span class="hljs-type">const</span> Node&amp;A)<span class="hljs-type">const</span>&#123;<br>		<span class="hljs-keyword">return</span> w&gt;A.w;<br>	&#125;<br>&#125;ask[N*N];<br><span class="hljs-type">bool</span> ans[N*N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> fr,to;<br>&#125;;<br>vector&lt;Edge&gt; vec[N];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(rint x)</span></span>&#123;<span class="hljs-keyword">return</span> x==fa[x]?fa[x]:fa[x]=<span class="hljs-built_in">find</span>(fa[x]);&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n,m,q;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;n,&amp;m,&amp;q);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s+<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=m;j++)&#123;<br>			idx[i][j]=++cnt;fa[cnt]=cnt;<br>			<span class="hljs-keyword">if</span>(s[j]==<span class="hljs-string">&#x27;1&#x27;</span>)f[i][j]=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">else</span> f[i][j]=<span class="hljs-built_in">min</span>(f[i<span class="hljs-number">-1</span>][j],<span class="hljs-built_in">min</span>(f[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>],f[i][j<span class="hljs-number">-1</span>]))+<span class="hljs-number">1</span>;<br>			vec[<span class="hljs-built_in">min</span>(f[i][j],f[i<span class="hljs-number">-1</span>][j])].<span class="hljs-built_in">push_back</span>((Edge)&#123;idx[i][j],idx[i<span class="hljs-number">-1</span>][j]&#125;);<br>			vec[<span class="hljs-built_in">min</span>(f[i][j],f[i][j<span class="hljs-number">-1</span>])].<span class="hljs-built_in">push_back</span>((Edge)&#123;idx[i][j],idx[i][j<span class="hljs-number">-1</span>]&#125;);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=q;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d%d%d&quot;</span>,&amp;ask[i].x,&amp;ask[i].y,&amp;ask[i].xx,&amp;ask[i].yy,&amp;ask[i].w),ask[i].id=i;<br>	<span class="hljs-built_in">sort</span>(ask+<span class="hljs-number">1</span>,ask+q+<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1e3</span>,j=<span class="hljs-number">1</span>;i;i--)&#123;<br>		<span class="hljs-keyword">for</span>(Edge v:vec[i])<br>			fa[<span class="hljs-built_in">find</span>(v.fr)]=<span class="hljs-built_in">find</span>(v.to);<br>		<span class="hljs-keyword">while</span>(j&lt;=q&amp;&amp;ask[j].w==i)&#123;<br>			<span class="hljs-keyword">if</span>(ask[j].x==ask[j].xx&amp;&amp;ask[j].y==ask[j].yy)ans[ask[j].id]=f[ask[j].x][ask[j].y]&gt;=ask[j].w;<br>			<span class="hljs-keyword">else</span> ans[ask[j].id]=<span class="hljs-built_in">find</span>(idx[ask[j].x][ask[j].y])==<span class="hljs-built_in">find</span>(idx[ask[j].xx][ask[j].yy]);<br>			j++;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=q;i++)<br>		<span class="hljs-built_in">puts</span>(ans[i]?<span class="hljs-string">&quot;Yes&quot;</span>:<span class="hljs-string">&quot;No&quot;</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h1><blockquote>
<p>给定一个 $0/1$ 串，要求所有的子序列中满足中心对称的点对个数。</p>
</blockquote>
<p>考虑直接推式子然后 $NTT$ 即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">18</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">998244353</span>;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Add</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x+=y;<span class="hljs-keyword">return</span> x&gt;=p?x-p:x;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Del</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x-=y;<span class="hljs-keyword">return</span> x&gt;=<span class="hljs-number">0</span>?x:x+p;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> ll <span class="hljs-title">Mul</span><span class="hljs-params">(rll x,rll y )</span></span>&#123;x*=y;<span class="hljs-keyword">return</span> x&gt;=p?x%p:x;&#125;<br><span class="hljs-function">ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-type">char</span> s[N];<br><span class="hljs-type">int</span> pw[N],fac[N],inv[N],w[N],r[N],f[N],g[N],cnt[N],pd,n,t;<br>ll res;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ntt</span><span class="hljs-params">(rint n,rint *a,rint typ)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(pd!=n)&#123;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;n;i++)<br>			r[i]=(r[i&gt;&gt;<span class="hljs-number">1</span>]&gt;&gt;<span class="hljs-number">1</span>)|((i&amp;<span class="hljs-number">1</span>)?n&gt;&gt;<span class="hljs-number">1</span>:<span class="hljs-number">0</span>);<br>		pd=n;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;n;i++)<br>		<span class="hljs-keyword">if</span>(i&lt;r[i])<span class="hljs-built_in">swap</span>(a[i],a[r[i]]);<br>	<span class="hljs-keyword">for</span>(rint mid=<span class="hljs-number">1</span>;mid&lt;n;mid&lt;&lt;=<span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;n;i+=mid&lt;&lt;<span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;mid;j++)<br>		t=<span class="hljs-built_in">Mul</span>(w[mid+j],a[i+j+mid]),a[i+j+mid]=<span class="hljs-built_in">Del</span>(a[i+j],t),a[i+j]=<span class="hljs-built_in">Add</span>(a[i+j],t);<br>	<span class="hljs-keyword">if</span>(~typ)<span class="hljs-keyword">return</span> ;<br>	t=<span class="hljs-built_in">fpow</span>(n,p<span class="hljs-number">-2</span>);<span class="hljs-built_in">reverse</span>(a+<span class="hljs-number">1</span>,a+n);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;n;i++)<br>		a[i]=<span class="hljs-built_in">Mul</span>(a[i],t);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint l,rint r)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(r-l&lt;=<span class="hljs-number">180</span>)&#123;<br>		<span class="hljs-keyword">for</span>(rint i=l;i&lt;=r;i++)<br>			<span class="hljs-keyword">for</span>(rint j=i+<span class="hljs-number">1</span>;j&lt;=r;j++)<br>				<span class="hljs-keyword">if</span>(s[i]==s[j])<br>					cnt[j-i]=<span class="hljs-built_in">Add</span>(cnt[j-i],<span class="hljs-built_in">Mul</span>(inv[i<span class="hljs-number">-1</span>],inv[n-j]));<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">dfs</span>(l,mid);<span class="hljs-built_in">dfs</span>(mid+<span class="hljs-number">1</span>,r);<br>	rint Max=<span class="hljs-number">1</span>,len=r-l+<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">while</span>(Max&lt;len)Max&lt;&lt;=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=l;i&lt;=mid;i++)<br>		g[i-l]=(s[i]==<span class="hljs-string">&#x27;0&#x27;</span>)?inv[i<span class="hljs-number">-1</span>]:<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=mid+<span class="hljs-number">1</span>;i&lt;=r;i++)<br>		f[i-l]=(s[i]==<span class="hljs-string">&#x27;0&#x27;</span>)?inv[n-i]:<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">ntt</span>(Max,f,<span class="hljs-number">-1</span>);<span class="hljs-built_in">ntt</span>(Max,g,<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;Max;i++)<br>		f[i]=<span class="hljs-built_in">Mul</span>(f[i],g[i]),g[i]=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">ntt</span>(Max,f,<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;len;i++)<br>		res+=<span class="hljs-built_in">Mul</span>(<span class="hljs-built_in">Mul</span>(f[i],pw[i<span class="hljs-number">-1</span>]),fac[n-i<span class="hljs-number">-1</span>]),f[i]=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=l;i&lt;=mid;i++)<br>		g[i-l]=(s[i]==<span class="hljs-string">&#x27;1&#x27;</span>)?inv[i<span class="hljs-number">-1</span>]:<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=mid+<span class="hljs-number">1</span>;i&lt;=r;i++)<br>		f[i-l]=(s[i]==<span class="hljs-string">&#x27;1&#x27;</span>)?inv[n-i]:<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">ntt</span>(Max,f,<span class="hljs-number">-1</span>);<span class="hljs-built_in">ntt</span>(Max,g,<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;Max;i++)<br>		f[i]=<span class="hljs-built_in">Mul</span>(f[i],g[i]),g[i]=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">ntt</span>(Max,f,<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;len;i++)<br>		cnt[i]=<span class="hljs-built_in">Add</span>(cnt[i],f[i]),f[i]=<span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	w[N/<span class="hljs-number">2</span>]=<span class="hljs-number">1</span>;w[N/<span class="hljs-number">2</span>+<span class="hljs-number">1</span>]=t=<span class="hljs-built_in">fpow</span>(<span class="hljs-number">3</span>,(p<span class="hljs-number">-1</span>)/N);<br>	<span class="hljs-keyword">for</span>(rint i=N/<span class="hljs-number">2</span>+<span class="hljs-number">2</span>;i&lt;N;i++)w[i]=<span class="hljs-built_in">Mul</span>(w[i<span class="hljs-number">-1</span>],t);<br>	<span class="hljs-keyword">for</span>(rint i=N/<span class="hljs-number">2</span><span class="hljs-number">-1</span>;i;i--)w[i]=w[i&lt;&lt;<span class="hljs-number">1</span>];<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s+<span class="hljs-number">1</span>);n=<span class="hljs-built_in">strlen</span>(s+<span class="hljs-number">1</span>);<br>	fac[<span class="hljs-number">0</span>]=fac[<span class="hljs-number">1</span>]=inv[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">1</span>]=pw[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;pw[<span class="hljs-number">1</span>]=<span class="hljs-number">2</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		fac[i]=<span class="hljs-built_in">Mul</span>(fac[i<span class="hljs-number">-1</span>],i);<br>		inv[i]=<span class="hljs-built_in">Del</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">Mul</span>(p/i,inv[p%i]));<br>		pw[i]=(pw[i<span class="hljs-number">-1</span>]&lt;&lt;<span class="hljs-number">1</span>)%p;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)<br>		inv[i]=<span class="hljs-built_in">Mul</span>(inv[i<span class="hljs-number">-1</span>],inv[i]);<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,n);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		res+=<span class="hljs-built_in">Mul</span>(<span class="hljs-built_in">Mul</span>(cnt[i],pw[i<span class="hljs-number">-1</span>]),fac[n-i<span class="hljs-number">-1</span>]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res%p);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="硬币游戏"><a href="#硬币游戏" class="headerlink" title="硬币游戏"></a>硬币游戏</h1><blockquote>
<p>有 $n$ 堆硬币，每堆硬币的价值由上到下依次为 $a_i,b_i,a_i$ ，取一枚硬币必须取走它上边的所有硬币，对于体积为 $1-k$ 时分别求出答案 。</p>
</blockquote>
<p>考虑若 $a_i&gt;b_i$ 那么在取走第一枚 $a_i$ 之后，剩下的两枚硬币一定是一起被取走的 。</p>
<p>然后若 $a_i&lt;b_i$ 那么前两枚硬币一定是一起取走的，于是可以得到一个结论，每堆硬币可以分为 $a_i+b_i$ 和 $a_i$ 两堆硬币，也就是说，现在相当于 $2n$ 个物品做 $0/1$ 背包，而不是做有依赖的背包了 。</p>
<p>由于体积只有两个，所以可以对两种体积分别排序，然后考虑取哪一个体积的物品 。</p>
<p>对于增加一个体积，只放一个体积的物品一定更优，对于两个体积的考虑回退一步即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">5e6</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">int</span> n,k,a[N],b[N];<br><span class="hljs-type">int</span> threshold=<span class="hljs-number">10000000</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> k1,k2;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">xorShift128Plus</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> k3=k1,k4=k2;<br>	k1=k4;<br>	k3^=k3&lt;&lt;<span class="hljs-number">23</span>;<br>	k2=k3^k4^(k3&gt;&gt;<span class="hljs-number">17</span>)^(k4&gt;&gt;<span class="hljs-number">26</span>);<br>	<span class="hljs-keyword">return</span> k2+k4;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">gen</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%llu%llu&quot;</span>,&amp;n,&amp;k,&amp;k1,&amp;k2);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		a[i]=<span class="hljs-built_in">xorShift128Plus</span>()%threshold+<span class="hljs-number">1</span>;<br>		b[i]=<span class="hljs-built_in">xorShift128Plus</span>()%threshold+<span class="hljs-number">1</span>;<br>	&#125;<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> id,val;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (<span class="hljs-type">const</span> Node&amp;A)<span class="hljs-type">const</span>&#123;<br>		<span class="hljs-keyword">return</span> val&gt;A.val;<br>	&#125;<br>&#125;q1[N*<span class="hljs-number">3</span>],q2[N*<span class="hljs-number">3</span>];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">gen</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		q1[i]=(Node)&#123;i,a[i]&#125;;<br>		q2[i]=(Node)&#123;i,a[i]+b[i]&#125;;<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(q1+<span class="hljs-number">1</span>,q1+n+<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">sort</span>(q2+<span class="hljs-number">1</span>,q2+n+<span class="hljs-number">1</span>);<br>	rint tp1=<span class="hljs-number">1</span>,tp2=<span class="hljs-number">1</span>;<br>	rll res=<span class="hljs-number">0</span>,res2=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=k;i++)&#123;<br>		<span class="hljs-keyword">if</span>(tp1&lt;=n&amp;&amp;tp2&lt;=n)&#123;<br>			<span class="hljs-keyword">if</span>(q1[tp1].val+q1[tp1+<span class="hljs-number">1</span>].val&lt;=q2[tp2].val)&#123;<br>				res2+=q1[tp1++].val;<br>				res^=res2;<br>				res2-=q1[--tp1].val;i++;<br>				<span class="hljs-keyword">if</span>(i&lt;=k)&#123;<br>					res2+=q2[tp2++].val;<br>					res^=res2;<br>				&#125;<br>			&#125;<span class="hljs-keyword">else</span> &#123;<br>				res2+=q1[tp1++].val;<br>				res^=res2;<br>			&#125;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(tp1&lt;=n)&#123;<br>			res2+=q1[tp1++].val;<br>			res^=res2;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(tp2&lt;=n)&#123;<br>			res2+=b[q2[tp2].id];<br>			res^=res2;i++;<br>			<span class="hljs-keyword">if</span>(i&lt;=k)&#123;<br>				res2+=a[q2[tp2++].id];<br>				res^=res2;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="序列计数"><a href="#序列计数" class="headerlink" title="序列计数"></a>序列计数</h1><blockquote>
<p>对一个字串，求某个区间中本质不同的非空子序列个数。</p>
</blockquote>
<h1 id="最大面积"><a href="#最大面积" class="headerlink" title="最大面积"></a>最大面积</h1><blockquote>
<p>给出若干个点，每次询问一个点与一个区间中所有点的叉积的和的最大值 。</p>
</blockquote>
<p>考虑直接推式子，$P\times A=P_xA_y-A_xP_y$，不妨设 $x$ 的前缀和为 $s_x$， $y$ 的前缀和为 $s_y$，那么要求的实际上是 $\max_{l,r}P_x(s_{yr}-s_{yl-1})-P_y(s_{xr}-s_{xl-1})$，可以直接 $n^2$ 求出所有可能的点对然后直接在凸包上进行二分即可，注意特判纵坐标为 $0$ 的情况 。</p>
<p>上述问题的主要时间复杂度在于求出全局的凸包，求这个可以考虑进行分治，考虑区间 $[l,r]$ ，考虑跨过区间中点的点形成的凸包，任意一个点都能够写成一个左区间的后缀和加上右区间的前缀和，所以可以对于两侧分别求一个凸包然后用闵可夫斯基和合并，最后统一跑一个大凸包即可 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>&#123;<br>	rint x=<span class="hljs-number">0</span>,f=<span class="hljs-number">1</span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-string">&#x27;0&#x27;</span>||ch&gt;<span class="hljs-string">&#x27;9&#x27;</span>)&#123;<span class="hljs-keyword">if</span>(ch==<span class="hljs-string">&#x27;-&#x27;</span>)f=<span class="hljs-number">-1</span>;ch=<span class="hljs-built_in">getchar</span>();&#125;<br>	<span class="hljs-keyword">while</span>(ch&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;ch&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)&#123;x=x*<span class="hljs-number">10</span>+ch-<span class="hljs-string">&#x27;0&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();&#125;<br>	<span class="hljs-keyword">return</span> x*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxlg=<span class="hljs-number">20</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> x,y;<br>&#125;a[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pt</span>&#123;<br>	ll x,y;<br>	Pt <span class="hljs-keyword">operator</span> + (<span class="hljs-type">const</span> Pt&amp;A)<span class="hljs-type">const</span>&#123;<span class="hljs-keyword">return</span> (Pt)&#123;x+A.x,y+A.y&#125;;&#125;<br>	Pt <span class="hljs-keyword">operator</span> - (<span class="hljs-type">const</span> Pt&amp;A)<span class="hljs-type">const</span>&#123;<span class="hljs-keyword">return</span> (Pt)&#123;x-A.x,y-A.y&#125;;&#125;<br>	ll <span class="hljs-keyword">operator</span> * (<span class="hljs-type">const</span> Pt&amp;A)<span class="hljs-type">const</span>&#123;<span class="hljs-keyword">return</span> x*A.y-y*A.x;&#125;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (<span class="hljs-type">const</span> Pt&amp;A)<span class="hljs-type">const</span>&#123;<span class="hljs-keyword">return</span> x==A.x?y&lt;A.y:x&lt;A.x;&#125;<br>&#125;b1[N*maxlg],b2[N*maxlg],up[N*maxlg],down[N*maxlg],t[N&lt;&lt;<span class="hljs-number">1</span>];<br>vector&lt;Pt&gt; vec,vec1,vec2;<br><span class="hljs-type">int</span> n,m,stk[N*maxlg],tp,tot1,tot2;<br>ll sx[N],sy[N];<br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cmp1</span><span class="hljs-params">(Pt a,Pt b)</span></span>&#123;<span class="hljs-keyword">return</span> a*b&gt;<span class="hljs-number">0</span>;&#125;<br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cmp2</span><span class="hljs-params">(Pt a,Pt b)</span></span>&#123;<span class="hljs-keyword">return</span> a*b&lt;<span class="hljs-number">0</span>;&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint l,rint r)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)&#123;<br>		b1[++tot1]=(Pt)&#123;(ll)a[l].y,(ll)a[l].x&#125;;<br>		b2[++tot2]=(Pt)&#123;(ll)a[l].y,(ll)a[l].x&#125;;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">dfs</span>(l,mid);<span class="hljs-built_in">dfs</span>(mid+<span class="hljs-number">1</span>,r);<br>	rll sx=<span class="hljs-number">0</span>,sy=<span class="hljs-number">0</span>;vec.<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=mid+<span class="hljs-number">1</span>;i&lt;=r;i++)&#123;<br>		sx+=a[i].y,sy+=a[i].x;<br>		vec.<span class="hljs-built_in">push_back</span>((Pt)&#123;sx,sy&#125;);<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(vec.<span class="hljs-built_in">begin</span>(),vec.<span class="hljs-built_in">end</span>());tp=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;vec.<span class="hljs-built_in">size</span>();i++)&#123;<br>		<span class="hljs-keyword">while</span>(tp&gt;<span class="hljs-number">1</span>&amp;&amp;(vec[i]-vec[stk[tp<span class="hljs-number">-1</span>]])*(vec[stk[tp]]-vec[stk[tp<span class="hljs-number">-1</span>]])&gt;=<span class="hljs-number">0</span>)tp--;<br>		stk[++tp]=i;<br>	&#125;<br>	vec1.<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tp;i++)<br>		vec1.<span class="hljs-built_in">push_back</span>(vec[stk[i]]);<br>	sx=sy=<span class="hljs-number">0</span>;vec.<span class="hljs-built_in">clear</span>();tp=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=mid;i&gt;=l;i--)&#123;<br>		sx+=a[i].y,sy+=a[i].x;<br>		vec.<span class="hljs-built_in">push_back</span>((Pt)&#123;sx,sy&#125;);<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(vec.<span class="hljs-built_in">begin</span>(),vec.<span class="hljs-built_in">end</span>());<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;vec.<span class="hljs-built_in">size</span>();i++)&#123;<br>		<span class="hljs-keyword">while</span>(tp&gt;<span class="hljs-number">1</span>&amp;&amp;(vec[i]-vec[stk[tp<span class="hljs-number">-1</span>]])*(vec[stk[tp]]-vec[stk[tp<span class="hljs-number">-1</span>]])&gt;=<span class="hljs-number">0</span>)tp--;<br>		stk[++tp]=i;<br>	&#125;<br>	vec2.<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tp;i++)<br>		vec2.<span class="hljs-built_in">push_back</span>(vec[stk[i]]);<br>	rint tt=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;vec1.<span class="hljs-built_in">size</span>();i++)<br>		t[++tt]=vec1[i]-vec1[i<span class="hljs-number">-1</span>];<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;vec2.<span class="hljs-built_in">size</span>();i++)<br>		t[++tt]=vec2[i]-vec2[i<span class="hljs-number">-1</span>];<br>	<span class="hljs-built_in">sort</span>(t+<span class="hljs-number">1</span>,t+tt+<span class="hljs-number">1</span>,cmp1);<br>	Pt now=vec1[<span class="hljs-number">0</span>]+vec2[<span class="hljs-number">0</span>];<br>	b1[++tot1]=now;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tt;i++)&#123;<br>		now=now+t[i];<br>		b1[++tot1]=now;<br>	&#125;<br>	sx=<span class="hljs-number">0</span>,sy=<span class="hljs-number">0</span>;vec.<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=mid+<span class="hljs-number">1</span>;i&lt;=r;i++)&#123;<br>		sx+=a[i].y,sy+=a[i].x;<br>		vec.<span class="hljs-built_in">push_back</span>((Pt)&#123;sx,sy&#125;);<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(vec.<span class="hljs-built_in">begin</span>(),vec.<span class="hljs-built_in">end</span>());tp=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;vec.<span class="hljs-built_in">size</span>();i++)&#123;<br>		<span class="hljs-keyword">while</span>(tp&gt;<span class="hljs-number">1</span>&amp;&amp;(vec[i]-vec[stk[tp<span class="hljs-number">-1</span>]])*(vec[stk[tp]]-vec[stk[tp<span class="hljs-number">-1</span>]])&lt;=<span class="hljs-number">0</span>)tp--;<br>		stk[++tp]=i;<br>	&#125;<br>	vec1.<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tp;i++)<br>		vec1.<span class="hljs-built_in">push_back</span>(vec[stk[i]]);<br>	sx=sy=<span class="hljs-number">0</span>;vec.<span class="hljs-built_in">clear</span>();tp=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=mid;i&gt;=l;i--)&#123;<br>		sx+=a[i].y,sy+=a[i].x;<br>		vec.<span class="hljs-built_in">push_back</span>((Pt)&#123;sx,sy&#125;);<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(vec.<span class="hljs-built_in">begin</span>(),vec.<span class="hljs-built_in">end</span>());<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;vec.<span class="hljs-built_in">size</span>();i++)&#123;<br>		<span class="hljs-keyword">while</span>(tp&gt;<span class="hljs-number">1</span>&amp;&amp;(vec[i]-vec[stk[tp<span class="hljs-number">-1</span>]])*(vec[stk[tp]]-vec[stk[tp<span class="hljs-number">-1</span>]])&lt;=<span class="hljs-number">0</span>)tp--;<br>		stk[++tp]=i;<br>	&#125;<br>	vec2.<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tp;i++)<br>		vec2.<span class="hljs-built_in">push_back</span>(vec[stk[i]]);<br>	tt=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;vec1.<span class="hljs-built_in">size</span>();i++)<br>		t[++tt]=vec1[i]-vec1[i<span class="hljs-number">-1</span>];<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;vec2.<span class="hljs-built_in">size</span>();i++)<br>		t[++tt]=vec2[i]-vec2[i<span class="hljs-number">-1</span>];<br>	<span class="hljs-built_in">sort</span>(t+<span class="hljs-number">1</span>,t+tt+<span class="hljs-number">1</span>,cmp2);<br>	now=vec1[<span class="hljs-number">0</span>]+vec2[<span class="hljs-number">0</span>];<br>	b2[++tot2]=now;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tt;i++)&#123;<br>		now=now+t[i];<br>		b2[++tot2]=now;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	n=<span class="hljs-built_in">read</span>(),m=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		a[i].x=<span class="hljs-built_in">read</span>(),a[i].y=<span class="hljs-built_in">read</span>();<br>		sx[i]=sx[i<span class="hljs-number">-1</span>]+a[i].x;<br>		sy[i]=sy[i<span class="hljs-number">-1</span>]+a[i].y;<br>	&#125;<br>	rll tmp1=<span class="hljs-number">0</span>,tmp2=<span class="hljs-number">0</span>,tmp3=<span class="hljs-number">0</span>,tmp4=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		tmp1=<span class="hljs-built_in">max</span>(tmp1,sy[i]+tmp3);<br>		tmp2=<span class="hljs-built_in">min</span>(tmp2,sy[i]+tmp4);<br>		tmp3=<span class="hljs-built_in">max</span>(tmp3,-sy[i]);<br>		tmp4=<span class="hljs-built_in">min</span>(tmp4,-sy[i]);<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,n);<br>	<span class="hljs-built_in">sort</span>(b1+<span class="hljs-number">1</span>,b1+tot1+<span class="hljs-number">1</span>);tp=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot1;i++)&#123;<br>		<span class="hljs-keyword">while</span>(tp&gt;<span class="hljs-number">1</span>&amp;&amp;(b1[i]-b1[stk[tp<span class="hljs-number">-1</span>]])*(b1[stk[tp]]-b1[stk[tp<span class="hljs-number">-1</span>]])&gt;=<span class="hljs-number">0</span>)tp--;<br>		stk[++tp]=i;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tp;i++)<br>		down[i]=b1[stk[i]];<br>	rint lim1=tp;<span class="hljs-built_in">sort</span>(b2+<span class="hljs-number">1</span>,b2+tot2+<span class="hljs-number">1</span>);tp=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot2;i++)&#123;<br>		<span class="hljs-keyword">while</span>(tp&gt;<span class="hljs-number">1</span>&amp;&amp;(b2[i]-b2[stk[tp<span class="hljs-number">-1</span>]])*(b2[stk[tp]]-b2[stk[tp<span class="hljs-number">-1</span>]])&lt;=<span class="hljs-number">0</span>)tp--;<br>		stk[++tp]=i;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tp;i++)<br>		up[i]=b2[stk[i]];<br>	rint lim2=tp;<br>	<span class="hljs-keyword">while</span>(m--)&#123;<br>		rint px=<span class="hljs-built_in">read</span>(),py=<span class="hljs-built_in">read</span>();<br>		rll res=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">if</span>(!py)res=<span class="hljs-built_in">max</span>(px*tmp1,px*tmp2);<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(py&lt;<span class="hljs-number">0</span>)&#123;<br>			rint l=<span class="hljs-number">2</span>,r=lim2,pos=<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">while</span>(l&lt;=r)&#123;<br>				rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">if</span>(<span class="hljs-number">1.0L</span>*(up[mid].y-up[mid<span class="hljs-number">-1</span>].y)/(up[mid].x-up[mid<span class="hljs-number">-1</span>].x)&gt;=<span class="hljs-number">1.0L</span>*px/py)pos=mid,l=mid+<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">else</span> r=mid<span class="hljs-number">-1</span>;<br>			&#125;<br>			res=px*up[pos].x-py*up[pos].y;<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			rint l=<span class="hljs-number">2</span>,r=lim1,pos=<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">while</span>(l&lt;=r)&#123;<br>				rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">if</span>(<span class="hljs-number">1.0L</span>*(down[mid].y-down[mid<span class="hljs-number">-1</span>].y)/(down[mid].x-down[mid<span class="hljs-number">-1</span>].x)&lt;=<span class="hljs-number">1.0L</span>*px/py)pos=mid,l=mid+<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">else</span> r=mid<span class="hljs-number">-1</span>;<br>			&#125;<br>			res=px*down[pos].x-py*down[pos].y;<br>		&#125;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,<span class="hljs-built_in">max</span>(res,<span class="hljs-number">0ll</span>));<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="战神归来"><a href="#战神归来" class="headerlink" title="战神归来"></a>战神归来</h1><blockquote>
<p>$n$ 个人坐地铁，第 $i$ 个人要从 $S_i$ 到 $E_i$ ，从第 $i$ 站到第 $j$ 站花费的代价是 $|i-j|$，一个人只能沿着自己原本的路线走，但是可以在某站停下来和别人交换地铁卡，这样的话就能够将起点设置为对方的起点从而达到逃票的效果，问最少支付多少钱并且给出方案 。</p>
</blockquote>
<p>首先考虑最少支付多少钱，可以考虑每一条边的贡献，如果有两个人走相反的方向，那么让这两个人换一下卡一定不劣，所以对于 $S_i&lt;E_i$ 的给这一段加一，否则减一，那么最终一条边的绝对值就是对答案的贡献。</p>
<p>考虑构造方案，不难发现只需要在能够换卡的时候随便换就行了，所以只需要维护这个东西，发现两种走法不是很好在一起考虑，因为走的方向是反的，于是将方向统一，即维护一条从左向右的扫描线，对于从左向右的点，在它的起点处加入这条线，对于从右向左的点，在它的终点处加入这条线，对于每一种线加入时考虑与它相对的那种线是否存在，如果存在就直接让两条线换卡，否则就加入队列，注意弹出不合法也就是右边的那个点没有跨过当前扫描线的情况，注意到一次换卡会在较短的那条线处结束，所以应该在结束的时候重新把较长的线加入，除非两条线一样长，考虑一次换卡操作最多只需要操作三次，最多换 $n$ 次卡，并且最后需要走到终点，于是操作次数是 $4n$ 级别的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">4e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> M=<span class="hljs-number">1e6</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">int</span> cnt[M],S[N],E[N],pre[N],nxt[N],rd[N],tot;<br>vector&lt;<span class="hljs-type">int</span>&gt; vec1[M],vec2[M],vec;<br>unordered_map&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; vis[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<span class="hljs-type">int</span> typ,u,v,pos;&#125;ans[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<span class="hljs-type">int</span> to,nxt;&#125;e[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> h[N],idx;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">mov</span><span class="hljs-params">(rint x,rint y,rint z)</span></span>&#123;<span class="hljs-keyword">if</span>(vis[x].<span class="hljs-built_in">find</span>(y)!=vis[x].<span class="hljs-built_in">end</span>())<span class="hljs-keyword">return</span> ;vis[x][y]=++tot;ans[tot]=(Node)&#123;<span class="hljs-number">0</span>,x,y,z&#125;;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">chg</span><span class="hljs-params">(rint x,rint y,rint z)</span></span>&#123;ans[++tot]=(Node)&#123;<span class="hljs-number">1</span>,x,y,z&#125;;&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node2</span>&#123;<br>	<span class="hljs-type">int</span> x,y;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (<span class="hljs-type">const</span> Node2&amp;A)<span class="hljs-type">const</span>&#123;<br>		<span class="hljs-keyword">return</span> y&lt;A.y;<br>	&#125;<br>&#125;;<br><span class="hljs-type">int</span> match[N],q[N],arr[N],hh,tt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Heap</span>&#123;<br>	Node2 val[N];<br>	<span class="hljs-type">int</span> cnt;<br>	<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">empty</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">return</span> cnt==<span class="hljs-number">0</span>;&#125;<br>	<span class="hljs-function">Node2 <span class="hljs-title">top</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">return</span> val[<span class="hljs-number">1</span>];&#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">push</span><span class="hljs-params">(Node2 v)</span></span>&#123;<br>		val[++cnt]=v;<br>		<span class="hljs-keyword">for</span>(rint p1=cnt,p2=cnt&gt;&gt;<span class="hljs-number">1</span>;p2;p1&gt;&gt;=<span class="hljs-number">1</span>,p2&gt;&gt;=<span class="hljs-number">1</span>)&#123;<br>			<span class="hljs-keyword">if</span>(val[p1]&lt;val[p2])<br>				<span class="hljs-built_in">swap</span>(val[p1],val[p2]);<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pop</span><span class="hljs-params">()</span></span>&#123;<br>		<span class="hljs-built_in">swap</span>(val[cnt],val[<span class="hljs-number">1</span>]);cnt--;<br>		<span class="hljs-keyword">for</span>(rint x=<span class="hljs-number">1</span>;;)&#123;<br>			rint ls=x&lt;&lt;<span class="hljs-number">1</span>,rs=x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">if</span>(rs&lt;=cnt&amp;&amp;val[rs]&lt;val[ls])&#123;<br>				<span class="hljs-keyword">if</span>(val[rs]&lt;val[x])<span class="hljs-built_in">swap</span>(val[x],val[rs]);<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>				x=rs;<br>			&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ls&lt;=cnt)&#123;<br>				<span class="hljs-keyword">if</span>(val[ls]&lt;val[x])<span class="hljs-built_in">swap</span>(val[x],val[ls]);<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>				x=ls;<br>			&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>&#125;q1,q2,q3;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">topsort</span><span class="hljs-params">()</span></span>&#123;<br>	hh=<span class="hljs-number">0</span>;tt=<span class="hljs-number">-1</span>;rint at=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot;i++)<br>		(!rd[i])?q[++tt]=i:<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(hh&lt;=tt)&#123;<br>		rint u=q[hh++];<br>		arr[++at]=u;<br>		<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>			rint v=e[i].to;<br>			(!--rd[v])?q[++tt]=v:<span class="hljs-number">0</span>;<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>&#123;<br>	rint x=<span class="hljs-number">0</span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-string">&#x27;0&#x27;</span>||ch&gt;<span class="hljs-string">&#x27;9&#x27;</span>)ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;ch&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)x=x*<span class="hljs-number">10</span>+ch-<span class="hljs-string">&#x27;0&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br><span class="hljs-type">char</span> stk[<span class="hljs-number">20</span>];<br><span class="hljs-type">int</span> tp;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(!x)<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;0&#x27;</span>);<br>	<span class="hljs-keyword">else</span> &#123;<br>		tp=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">while</span>(x)<br>			stk[++tp]=x%<span class="hljs-number">10</span>+<span class="hljs-string">&#x27;0&#x27;</span>,x/=<span class="hljs-number">10</span>;<br>		<span class="hljs-keyword">while</span>(tp)<br>			<span class="hljs-built_in">putchar</span>(stk[tp--]);<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint T=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">while</span>(T--)&#123;<br>		<span class="hljs-built_in">memset</span>(nxt,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(nxt));<br>		<span class="hljs-built_in">memset</span>(rd,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(rd));<br>		<span class="hljs-built_in">memset</span>(h,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(h));idx=<span class="hljs-number">0</span>;<br>		<span class="hljs-built_in">memset</span>(cnt,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(cnt));tot=<span class="hljs-number">0</span>;<br>		rint n=<span class="hljs-built_in">read</span>(),m=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>			S[i]=<span class="hljs-built_in">read</span>();E[i]=<span class="hljs-built_in">read</span>();<br>			cnt[S[i]]++,cnt[E[i]]--;<br>			<span class="hljs-keyword">if</span>(S[i]&lt;E[i])vec1[S[i]].<span class="hljs-built_in">push_back</span>(i);<br>			<span class="hljs-keyword">else</span> vec2[E[i]].<span class="hljs-built_in">push_back</span>(i);<br>			vis[i].<span class="hljs-built_in">clear</span>();<br>			vis[i][S[i]]=<span class="hljs-number">0</span>;<br>		&#125;<br>		rll res=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=m;i++)&#123;<br>			cnt[i]+=cnt[i<span class="hljs-number">-1</span>];<br>			res+=<span class="hljs-built_in">abs</span>(cnt[i]);<br>			<span class="hljs-keyword">while</span>(!q1.<span class="hljs-built_in">empty</span>()&amp;&amp;q1.<span class="hljs-built_in">top</span>().y==i)q1.<span class="hljs-built_in">pop</span>();<br>			<span class="hljs-keyword">while</span>(!q2.<span class="hljs-built_in">empty</span>()&amp;&amp;q2.<span class="hljs-built_in">top</span>().y==i)q2.<span class="hljs-built_in">pop</span>();<br>			<span class="hljs-keyword">while</span>(!q3.<span class="hljs-built_in">empty</span>()&amp;&amp;q3.<span class="hljs-built_in">top</span>().y==i)&#123;<br>				rint x=q3.<span class="hljs-built_in">top</span>().x;q3.<span class="hljs-built_in">pop</span>();<br>				match[match[x]]=<span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">if</span>(S[match[x]]&lt;E[match[x]]&amp;&amp;E[match[x]]!=i)q1.<span class="hljs-built_in">push</span>((Node2)&#123;match[x],E[match[x]]&#125;);<br>				<span class="hljs-keyword">if</span>(S[match[x]]&gt;E[match[x]]&amp;&amp;S[match[x]]!=i)q2.<span class="hljs-built_in">push</span>((Node2)&#123;match[x],S[match[x]]&#125;);<br>				match[x]=<span class="hljs-number">0</span>;<br>			&#125;<br>			<span class="hljs-keyword">while</span>(!q1.<span class="hljs-built_in">empty</span>()&amp;&amp;!q2.<span class="hljs-built_in">empty</span>())&#123;<br>				Node2 x=q1.<span class="hljs-built_in">top</span>(),y=q2.<span class="hljs-built_in">top</span>();<br>				q1.<span class="hljs-built_in">pop</span>();q2.<span class="hljs-built_in">pop</span>();<br>				match[x.x]=y.x;match[y.x]=x.x;<br>				<span class="hljs-built_in">mov</span>(x.x,i,i);<span class="hljs-built_in">mov</span>(y.x,i,i);<span class="hljs-built_in">chg</span>(x.x,y.x,i);<br>				<span class="hljs-keyword">if</span>(x.y&lt;y.y)q3.<span class="hljs-built_in">push</span>(x);<br>				<span class="hljs-keyword">else</span> q3.<span class="hljs-built_in">push</span>(y);<br>			&#125;<br>			<span class="hljs-keyword">for</span>(rint v:vec1[i])&#123;<br>				<span class="hljs-keyword">if</span>(!q2.<span class="hljs-built_in">empty</span>())&#123;<br>					Node2 u=q2.<span class="hljs-built_in">top</span>();q2.<span class="hljs-built_in">pop</span>();<br>					match[u.x]=v;match[v]=u.x;<br>					<span class="hljs-built_in">mov</span>(u.x,i,i);<span class="hljs-built_in">mov</span>(v,i,i);<span class="hljs-built_in">chg</span>(u.x,v,i);<br>					<span class="hljs-keyword">if</span>(u.y&lt;E[v])q3.<span class="hljs-built_in">push</span>((Node2)&#123;u.x,u.y&#125;);<br>					<span class="hljs-keyword">else</span> q3.<span class="hljs-built_in">push</span>((Node2)&#123;v,E[v]&#125;);<br>				&#125;<span class="hljs-keyword">else</span> q1.<span class="hljs-built_in">push</span>((Node2)&#123;v,E[v]&#125;);<br>			&#125;<br>			<span class="hljs-keyword">for</span>(rint v:vec2[i])&#123;<br>				<span class="hljs-keyword">if</span>(!q1.<span class="hljs-built_in">empty</span>())&#123;<br>					Node2 u=q1.<span class="hljs-built_in">top</span>();q1.<span class="hljs-built_in">pop</span>();<br>					match[u.x]=v;match[v]=u.x;<br>					<span class="hljs-built_in">mov</span>(u.x,i,i);<span class="hljs-built_in">mov</span>(v,i,i);<span class="hljs-built_in">chg</span>(u.x,v,i);<br>					<span class="hljs-keyword">if</span>(u.y&lt;S[v])q3.<span class="hljs-built_in">push</span>((Node2)&#123;u.x,u.y&#125;);<br>					<span class="hljs-keyword">else</span> q3.<span class="hljs-built_in">push</span>((Node2)&#123;v,S[v]&#125;);<br>				&#125;<span class="hljs-keyword">else</span> q2.<span class="hljs-built_in">push</span>((Node2)&#123;v,S[v]&#125;);<br>			&#125;<br>			vec1[i].<span class="hljs-built_in">clear</span>();<br>			vec2[i].<span class="hljs-built_in">clear</span>();<br>		&#125;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>			<span class="hljs-built_in">mov</span>(i,E[i],E[i]);<br>			vec.<span class="hljs-built_in">clear</span>();<br>			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> v:vis[i])<br>				vec.<span class="hljs-built_in">push_back</span>(v.first);<br>			<span class="hljs-keyword">if</span>(S[i]&lt;E[i])<span class="hljs-built_in">sort</span>(vec.<span class="hljs-built_in">begin</span>(),vec.<span class="hljs-built_in">end</span>(),[](rint x,rint y)&#123;<span class="hljs-keyword">return</span> x&lt;y;&#125;);<br>			<span class="hljs-keyword">else</span> <span class="hljs-built_in">sort</span>(vec.<span class="hljs-built_in">begin</span>(),vec.<span class="hljs-built_in">end</span>(),[](rint x,rint y)&#123;<span class="hljs-keyword">return</span> x&gt;y;&#125;);<br>			rint lst=<span class="hljs-number">0</span>;pre[i]=vis[i][vec[<span class="hljs-number">1</span>]];<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;vec.<span class="hljs-built_in">size</span>();j++)&#123;<br>				rint x=vis[i][vec[j]];<br>				nxt[lst]=x;<br>				<span class="hljs-keyword">if</span>(lst)<span class="hljs-built_in">Ins</span>(lst,x),rd[x]++;<br>				lst=x;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot;i++)&#123;<br>			<span class="hljs-keyword">if</span>(ans[i].typ==<span class="hljs-number">1</span>)&#123;<br>				rint x=vis[ans[i].u][ans[i].pos],y=vis[ans[i].v][ans[i].pos];<br>				<span class="hljs-keyword">if</span>(x)<span class="hljs-built_in">Ins</span>(x,i),rd[i]++;<br>				<span class="hljs-keyword">if</span>(x&amp;&amp;nxt[x])<span class="hljs-built_in">Ins</span>(i,nxt[x]),rd[nxt[x]]++;<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ans[i].pos!=E[ans[i].u])<span class="hljs-built_in">Ins</span>(i,pre[ans[i].u]),rd[pre[ans[i].u]]++;<br>				<span class="hljs-keyword">if</span>(y)<span class="hljs-built_in">Ins</span>(y,i),rd[i]++;<br>				<span class="hljs-keyword">if</span>(y&amp;&amp;nxt[y])<span class="hljs-built_in">Ins</span>(i,nxt[y]),rd[nxt[y]]++;<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ans[i].pos!=E[ans[i].v])<span class="hljs-built_in">Ins</span>(i,pre[ans[i].v]),rd[pre[ans[i].v]]++;<br>			&#125;<br>		&#125;<br>		<span class="hljs-built_in">topsort</span>();<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld %d\n&quot;</span>,res,tot);<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot;i++)<br>			<span class="hljs-built_in">print</span>(ans[arr[i]].typ),<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>),<span class="hljs-built_in">print</span>(ans[arr[i]].u),<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>),<span class="hljs-built_in">print</span>(ans[arr[i]].v),<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="组合数问题"><a href="#组合数问题" class="headerlink" title="组合数问题"></a>组合数问题</h1><blockquote>
<p>给定 $n,m$ ，求 $\sum_{i=0}^n(-1)^i\sum_{j=0}^nj^m\binom{j}{i}(m+i)^j$ 。</p>
</blockquote>
<p>首先发现这个 $i$ 在最外边但是只有一个 $-1$ 比较浪费，所以考虑把 $j$ 换出来，然后大力推式子 。</p>
<p>$$<br>\begin{aligned}<br>\sum_{i=0}^n(-1)^i\sum_{j=0}^nj^m\binom{j}{i}(m+i)^j&amp;=\sum_{j=0}^nj^m\sum_{i=0}^n(-1)^i\binom{j}{i}\sum_{k=0}^j\binom{j}{k}m^{j-k}i^k\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}\sum_{i=0}^n(-1)^i\binom{j}{i}\sum_{x=0}^i\binom{i}{x}{k \brace x}x!\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}\sum_{x=0}^n{k \brace x}x!\sum_{i=0}^n(-1)^i\binom{j}{i}\binom{i}{x}\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}\sum_{x=0}^n{k \brace x}x!\sum_{i=0}^n(-1)^i\binom{j}{x}\binom{j-x}{i-x}\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}\sum_{x=0}^n\binom{j}{x}{k \brace x}x!\sum_{i=0}^n(-1)^i\binom{j-x}{i-x}\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}\sum_{x=0}^n\binom{j}{x}{k \brace x}x!(-1)^x\sum_{i=0}^n(-1)^{i-x}\binom{j-x}{i-x}\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}\sum_{x=0}^n\binom{j}{x}{k \brace x}x!(-1)^x\sum_{i=0}^n(-1)^{i}\binom{j-x}{i}\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}\sum_{x=0}^n\binom{j}{x}{k \brace x}x!(-1)^x[j==x]\<br>&amp;=\sum_{j=0}^nj^m\sum_{k=0}^j\binom{j}{k}m^{j-k}{k \brace j}j!(-1)^j\<br>&amp;=\sum_{j=0}^nj^mj!(-1)^j\<br>\end{aligned}<br>$$</p>
<p>然后就是一个十分好算的式子，直接算就行了，注意以后推式子的时候一直往下推，推到不能推再回溯 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">998244353</span>;<br>ll fac[N],inv[N];<br><span class="hljs-function">ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n,m;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	fac[<span class="hljs-number">0</span>]=fac[<span class="hljs-number">1</span>]=inv[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		fac[i]=fac[i<span class="hljs-number">-1</span>]*i%p;<br>		inv[i]=p-p/i*inv[p%i]%p;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)<br>		inv[i]=inv[i]*inv[i<span class="hljs-number">-1</span>]%p;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=n;i++)<br>		res+=(i&amp;<span class="hljs-number">1</span>?<span class="hljs-number">-1</span>:<span class="hljs-number">1</span>)*<span class="hljs-built_in">fpow</span>(i,m)*fac[i]%p;<br>	res=(res%p+p)%p;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="三角形"><a href="#三角形" class="headerlink" title="三角形"></a>三角形</h1><blockquote>
<p>定义一个点是好点当且仅当这个点的坐标 $1\leq x \leq n$，$1\leq y \leq m$，并且这个点的坐标都是整数 。</p>
<p>求有多少个三角形的三个顶点都是好点并且三角形内不包含其它好点 。</p>
</blockquote>
<p>于是发现对于所有的三角形，其最长边一定在一个矩形的对角线上，所以只需要枚举一条对角线算贡献即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e7</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Add</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x+=y;<span class="hljs-keyword">return</span> x&gt;=p?x-p:x;&#125;<br><span class="hljs-type">int</span> pri[N],s[N];<br><span class="hljs-type">bool</span> npri[N];<br>unordered_map&lt;ll,ll&gt; dp1,dp2,dp3,dp4;<br><span class="hljs-function">ll <span class="hljs-title">S1</span><span class="hljs-params">(rll n)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;=<span class="hljs-number">2e7</span>)<span class="hljs-keyword">return</span> s[n];<br>	<span class="hljs-keyword">if</span>(dp1.<span class="hljs-built_in">find</span>(n)!=dp1.<span class="hljs-built_in">end</span>())<span class="hljs-keyword">return</span> dp1[n];<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rll l=<span class="hljs-number">2</span>,r;l&lt;=n;l=r+<span class="hljs-number">1</span>)&#123;<br>		r=n/(n/l);<br>		res-=(r-l+<span class="hljs-number">1</span>)%p*<span class="hljs-built_in">S1</span>(n/l)%p;<br>	&#125;<br>	<span class="hljs-keyword">return</span> dp1[n]=(res%p+p)%p;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">solve1</span><span class="hljs-params">(rll n,rll m)</span></span>&#123;<br>	pri[<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;s[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">memset</span>(npri,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(npri));<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">2e7</span>;i++)&#123;<br>		<span class="hljs-keyword">if</span>(!npri[i])&#123;<br>			pri[++pri[<span class="hljs-number">0</span>]]=i;<br>			s[i]=p<span class="hljs-number">-1</span>;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=pri[<span class="hljs-number">0</span>]&amp;&amp;i*pri[j]&lt;=<span class="hljs-number">2e7</span>;j++)&#123;<br>			npri[i*pri[j]]=<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">if</span>(i%pri[j]==<span class="hljs-number">0</span>)&#123;<br>				s[i*pri[j]]=<span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			s[i*pri[j]]=p-s[i];<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">2e7</span>;i++)<br>		s[i]=<span class="hljs-built_in">Add</span>(s[i<span class="hljs-number">-1</span>],s[i]);<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rll l=<span class="hljs-number">1</span>,r;l&lt;=n&amp;&amp;l&lt;=m;l=r+<span class="hljs-number">1</span>)&#123;<br>		r=<span class="hljs-built_in">min</span>(n/(n/l),m/(m/l));<br>		res+=(n/l%p)*(m/l%p)%p*(<span class="hljs-built_in">S1</span>(r)-<span class="hljs-built_in">S1</span>(l<span class="hljs-number">-1</span>))%p;<br>	&#125;<br>	res=(res%p+p)%p*n%p*m%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> ll <span class="hljs-title">sum1</span><span class="hljs-params">(rll n)</span></span>&#123;<br>	n%=p;<span class="hljs-keyword">return</span> n*(n+<span class="hljs-number">1</span>)%p*(p+<span class="hljs-number">1</span>&gt;&gt;<span class="hljs-number">1</span>)%p;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> ll <span class="hljs-title">sum2</span><span class="hljs-params">(rll n)</span></span>&#123;<br>	n%=p;<span class="hljs-keyword">return</span> (<span class="hljs-number">2</span>*n+<span class="hljs-number">1</span>)*n%p*(n+<span class="hljs-number">1</span>)%p*<span class="hljs-number">166666668</span>%p;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">S2</span><span class="hljs-params">(rll n)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;=<span class="hljs-number">2e7</span>)<span class="hljs-keyword">return</span> s[n];<br>	<span class="hljs-keyword">if</span>(dp2.<span class="hljs-built_in">find</span>(n)!=dp2.<span class="hljs-built_in">end</span>())<span class="hljs-keyword">return</span> dp2[n];<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rll l=<span class="hljs-number">2</span>,r;l&lt;=n;l=r+<span class="hljs-number">1</span>)&#123;<br>		r=n/(n/l);<br>		res-=(<span class="hljs-built_in">sum1</span>(r)-<span class="hljs-built_in">sum1</span>(l<span class="hljs-number">-1</span>))*<span class="hljs-built_in">S2</span>(n/l)%p;<br>	&#125;<br>	<span class="hljs-keyword">return</span> dp2[n]=(res%p+p)%p;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">solve2</span><span class="hljs-params">(rll n,rll m)</span></span>&#123;<br>	pri[<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;s[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">memset</span>(npri,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(npri));<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">2e7</span>;i++)&#123;<br>		<span class="hljs-keyword">if</span>(!npri[i])&#123;<br>			pri[++pri[<span class="hljs-number">0</span>]]=i;<br>			s[i]=<span class="hljs-number">1ll</span>*(p<span class="hljs-number">-1</span>)*i%p;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=pri[<span class="hljs-number">0</span>]&amp;&amp;i*pri[j]&lt;=<span class="hljs-number">2e7</span>;j++)&#123;<br>			npri[i*pri[j]]=<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">if</span>(i%pri[j]==<span class="hljs-number">0</span>)&#123;<br>				s[i*pri[j]]=<span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			s[i*pri[j]]=<span class="hljs-number">1ll</span>*(p-s[i])*pri[j]%p;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">2e7</span>;i++)<br>		s[i]=<span class="hljs-built_in">Add</span>(s[i<span class="hljs-number">-1</span>],s[i]);<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rll l=<span class="hljs-number">1</span>,r;l&lt;=n&amp;&amp;l&lt;=m;l=r+<span class="hljs-number">1</span>)&#123;<br>		r=<span class="hljs-built_in">min</span>(n/(n/l),m/(m/l));<br>		res+=(<span class="hljs-built_in">S2</span>(r)-<span class="hljs-built_in">S2</span>(l<span class="hljs-number">-1</span>))*((n/l)*<span class="hljs-built_in">sum1</span>(m/l)%p*n%p+(m/l)*<span class="hljs-built_in">sum1</span>(n/l)%p*m%p)%p;<br>	&#125;<br>	<span class="hljs-keyword">return</span> (res%p+p)%p;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">S4</span><span class="hljs-params">(rll n)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;=<span class="hljs-number">2e7</span>)<span class="hljs-keyword">return</span> s[n];<br>	<span class="hljs-keyword">if</span>(dp4.<span class="hljs-built_in">find</span>(n)!=dp4.<span class="hljs-built_in">end</span>())<span class="hljs-keyword">return</span> dp4[n];<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rll l=<span class="hljs-number">2</span>,r;l&lt;=n;l=r+<span class="hljs-number">1</span>)&#123;<br>		r=n/(n/l);<br>		res-=(<span class="hljs-built_in">sum2</span>(r)-<span class="hljs-built_in">sum2</span>(l<span class="hljs-number">-1</span>))%p*<span class="hljs-built_in">S4</span>(n/l)%p;<br>	&#125;<br>	<span class="hljs-keyword">return</span> dp4[n]=(res%p+p)%p;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">solve4</span><span class="hljs-params">(rll n,rll m)</span></span>&#123;<br>	pri[<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;s[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">memset</span>(npri,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(npri));<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">2e7</span>;i++)&#123;<br>		<span class="hljs-keyword">if</span>(!npri[i])&#123;<br>			pri[++pri[<span class="hljs-number">0</span>]]=i;<br>			s[i]=<span class="hljs-number">1ll</span>*(p<span class="hljs-number">-1</span>)*i%p*i%p;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=pri[<span class="hljs-number">0</span>]&amp;&amp;i*pri[j]&lt;=<span class="hljs-number">2e7</span>;j++)&#123;<br>			npri[i*pri[j]]=<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">if</span>(i%pri[j]==<span class="hljs-number">0</span>)&#123;<br>				s[i*pri[j]]=<span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			s[i*pri[j]]=<span class="hljs-number">1ll</span>*(p-s[i])*pri[j]%p*pri[j]%p;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">2e7</span>;i++)<br>		s[i]=<span class="hljs-built_in">Add</span>(s[i<span class="hljs-number">-1</span>],s[i]);<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rll l=<span class="hljs-number">1</span>,r;l&lt;=n&amp;&amp;l&lt;=m;l=r+<span class="hljs-number">1</span>)&#123;<br>		r=<span class="hljs-built_in">min</span>(n/(n/l),m/(m/l));<br>		res+=(<span class="hljs-built_in">S4</span>(r)-<span class="hljs-built_in">S4</span>(l<span class="hljs-number">-1</span>))*<span class="hljs-built_in">sum1</span>(n/l)%p*<span class="hljs-built_in">sum1</span>(m/l)%p;<br>	&#125;<br>	<span class="hljs-keyword">return</span> (res%p+p)%p;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rll n,m;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%lld%lld&quot;</span>,&amp;n,&amp;m);<br>	rll res=<span class="hljs-built_in">solve1</span>(n,m)-<span class="hljs-built_in">solve2</span>(n,m)+<span class="hljs-built_in">solve4</span>(n,m);<br>	res=(res%p+p)*<span class="hljs-number">4</span>%p;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res%p);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="树"><a href="#树" class="headerlink" title="树"></a>树</h1><p>读题题 。</p>
<p>考虑给出的函数 $f_u$，是从上向下考虑的，这样做并不是很好考虑，因为一个点可能有很多子树，可以将它反过来，枚举终点，那么跳到它的可能性是 $2^d$ ，所以只需要维护 $\sum 2^d$ 即可，考虑最终每个点的贡献，是类似 $k\times 2^d+b$ 的形式，所以只需要用树状数组维护 $k$ 即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">5e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">998244353</span>;<br><span class="hljs-function">ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;<br>	e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>&#125;<br><span class="hljs-type">int</span> pt[N];<br>ll sum[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint u,rint pw)</span></span>&#123;<br>	sum[pt[u]]+=pw;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-built_in">dfs</span>(v,(pw&lt;&lt;<span class="hljs-number">1</span>)%p);<br>	&#125;<br>&#125;<br><span class="hljs-type">int</span> siz[N],dfn[N],rk[N],Time;<br>ll tr[N],val[N],s[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(rint x,rll v)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(;x&lt;=Time;x+=x&amp;-x)<br>		tr[x]+=v;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">query</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(;x;x&amp;=x<span class="hljs-number">-1</span>)<br>		res+=tr[x];<br>	<span class="hljs-keyword">return</span> res%p;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint u)</span></span>&#123;<br>	siz[u]=<span class="hljs-number">1</span>;dfn[u]=++Time;rk[Time]=u;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		val[v]=(val[u]&lt;&lt;<span class="hljs-number">1</span>)%p;<br>		<span class="hljs-built_in">dfs</span>(v);<br>		siz[u]+=siz[v];<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		rint x;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x);<br>		<span class="hljs-built_in">Ins</span>(x,i);<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;pt[i]);<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">memset</span>(h,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(h));idx=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);sum[<span class="hljs-number">1</span>]%=p;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		rint x;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x);<br>		<span class="hljs-built_in">Ins</span>(x,i);<br>		sum[i]%=p;<br>	&#125;<br>	val[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>);<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		res+=sum[i];<br>		s[i]=(s[i<span class="hljs-number">-1</span>]+val[rk[i]])%p;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res%p);<br>	rint q;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	<span class="hljs-keyword">while</span>(q--)&#123;<br>		rint x,y;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y);<br>		rll now=(<span class="hljs-built_in">query</span>(dfn[x])*val[x]+sum[x])%p*<span class="hljs-built_in">fpow</span>(val[y],p<span class="hljs-number">-2</span>)*<span class="hljs-number">2</span>%p;<br>		<span class="hljs-built_in">update</span>(dfn[y],now);<br>		<span class="hljs-built_in">update</span>(dfn[y]+siz[y],p-now);<br>		res+=now*(s[dfn[y]+siz[y]<span class="hljs-number">-1</span>]-s[dfn[y]<span class="hljs-number">-1</span>])%p;<br>		res=(res%p+p)%p;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res%p);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="网格"><a href="#网格" class="headerlink" title="网格"></a>网格</h1><blockquote>
<p>给出一张网格图，有一些格子不能走，只能向下或者向右走，每次询问从一个点能不能走到另一个点 。</p>
</blockquote>
<p>有一个显然的 $\frac{n^4}{32}$ 的做法，不过貌似过不去，考虑进行常数优化，首先可以手写 $bitset$ 做到除数是 $64$，然后可以在里边拆出来一位表示行，这样可以再除以 $2$，最后是 $\frac{n^4}{128}$ ，应该可以过 。</p>
<p>考虑另一个比较靠谱的做法，对整张图进行分治，每次考虑跨过分治中心的询问，并把不跨过的向两侧递归，最后的时间复杂度是 $\frac{nm^2logn}{32}$ 。</p>
<p>其实已经想到了可以找几个特殊点，但是一直不知道找什么特殊点比较好，并且发现特殊点的做法是错的，没有扩展到找一条线就是对的，扩展了可能也不会做，因为没怎么用过分治，对于这种找点的问题可以进行分治，每次找中心然后分开递归 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">510</span>;<br><span class="hljs-type">char</span> s[N][N];<br>bitset&lt;N&gt; f[N][N],g[N][N];<br><span class="hljs-type">int</span> n,m,q;<br><span class="hljs-type">bool</span> ans[<span class="hljs-number">600010</span>];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> id,x,y,xx,yy;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint l,rint r,vector&lt;Node&gt; vec)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(vec.<span class="hljs-built_in">empty</span>())<span class="hljs-keyword">return</span> ;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=m;i++)&#123;<br>		g[mid][i].<span class="hljs-built_in">reset</span>();<br>		<span class="hljs-keyword">if</span>(s[mid][i]==<span class="hljs-string">&#x27;.&#x27;</span>)<br>			g[mid][i]=g[mid][i<span class="hljs-number">-1</span>],g[mid][i].<span class="hljs-built_in">set</span>(i);<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=m;i;i--)&#123;<br>		f[mid][i].<span class="hljs-built_in">reset</span>();<br>		<span class="hljs-keyword">if</span>(s[mid][i]==<span class="hljs-string">&#x27;.&#x27;</span>)<br>			f[mid][i]=f[mid][i+<span class="hljs-number">1</span>],f[mid][i].<span class="hljs-built_in">set</span>(i);<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=mid<span class="hljs-number">-1</span>;i&gt;=l;i--)<br>		<span class="hljs-keyword">for</span>(rint j=m;j;j--)&#123;<br>			<span class="hljs-keyword">if</span>(s[i][j]==<span class="hljs-string">&#x27;.&#x27;</span>)f[i][j]=f[i+<span class="hljs-number">1</span>][j]|f[i][j+<span class="hljs-number">1</span>];<br>			<span class="hljs-keyword">else</span> f[i][j].<span class="hljs-built_in">reset</span>();<br>		&#125;<br>	<span class="hljs-keyword">for</span>(rint i=mid+<span class="hljs-number">1</span>;i&lt;=r;i++)<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=m;j++)&#123;<br>			<span class="hljs-keyword">if</span>(s[i][j]==<span class="hljs-string">&#x27;.&#x27;</span>)g[i][j]=g[i<span class="hljs-number">-1</span>][j]|g[i][j<span class="hljs-number">-1</span>];<br>			<span class="hljs-keyword">else</span> g[i][j].<span class="hljs-built_in">reset</span>();<br>		&#125;<br>	vector&lt;Node&gt; vl,vr;<br>	<span class="hljs-keyword">for</span>(Node v:vec)&#123;<br>		<span class="hljs-keyword">if</span>(v.x&gt;mid)vr.<span class="hljs-built_in">push_back</span>(v);<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(v.xx&lt;mid)vl.<span class="hljs-built_in">push_back</span>(v);<br>		<span class="hljs-keyword">else</span> ans[v.id]=(f[v.x][v.y]&amp;g[v.xx][v.yy]).<span class="hljs-built_in">any</span>();<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(l,mid<span class="hljs-number">-1</span>,vl);<br>	<span class="hljs-built_in">dfs</span>(mid+<span class="hljs-number">1</span>,r,vr);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s[i]+<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	vector&lt;Node&gt; vec;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=q;i++)&#123;<br>		rint x,y,xx,yy;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d%d&quot;</span>,&amp;x,&amp;y,&amp;xx,&amp;yy);<br>		vec.<span class="hljs-built_in">push_back</span>((Node)&#123;i,x,y,xx,yy&#125;);<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,n,vec);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=q;i++)<br>		<span class="hljs-built_in">puts</span>(ans[i]?<span class="hljs-string">&quot;Yes&quot;</span>:<span class="hljs-string">&quot;No&quot;</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="点分治"><a href="#点分治" class="headerlink" title="点分治"></a>点分治</h1><blockquote>
<p>对一棵基环树进行点分治，求最后时间复杂度的期望值。</p>
</blockquote>
<p>可以考虑任意两个点之间的贡献，一个点对另一个点有贡献，当且仅当存在一条路径使得在这条路径上，这个点是第一个被删除的，如果两个点间只有一条路径，那么最后的答案是显然的，如果有多条路径，还需要容斥一下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e3</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-function">ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx=<span class="hljs-number">1</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;<br>	e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>&#125;<br><span class="hljs-type">bool</span> incir[N],vis[N];<br>vector&lt;<span class="hljs-type">int</span>&gt; vec;<br><span class="hljs-type">int</span> inv[N],stk[N],tp;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getcir</span><span class="hljs-params">(rint u,rint fa)</span></span>&#123;<br>	stk[++tp]=u;<br>	vis[u]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(i==fa)<span class="hljs-keyword">continue</span>;<br>		<span class="hljs-keyword">if</span>(vis[v])&#123;<br>			<span class="hljs-keyword">if</span>(vec.<span class="hljs-built_in">empty</span>())&#123;<br>				<span class="hljs-keyword">for</span>(rint j=tp;j;j--)&#123;<br>					rint x=stk[j];<br>					incir[x]=<span class="hljs-number">1</span>;<br>					vec.<span class="hljs-built_in">push_back</span>(x);<br>					<span class="hljs-keyword">if</span>(x==v)<span class="hljs-keyword">break</span>;<br>				&#125;<br>			&#125;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-built_in">getcir</span>(v,i^<span class="hljs-number">1</span>);<br>	&#125;<br>	tp--;<br>&#125;<br><span class="hljs-type">int</span> col[N],dis[N],dis2[N],fp[N][<span class="hljs-number">22</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint u,rint rt)</span></span>&#123;<br>	col[u]=rt;dis[u]=dis[fp[u][<span class="hljs-number">0</span>]]+<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;fp[u][i];i++)<br>		fp[u][i+<span class="hljs-number">1</span>]=fp[fp[u][i]][i];<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(incir[v]||v==fp[u][<span class="hljs-number">0</span>])<span class="hljs-keyword">continue</span>;<br>		fp[v][<span class="hljs-number">0</span>]=u;<br>		<span class="hljs-built_in">dfs</span>(v,rt);<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">lca</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(dis[x]&lt;dis[y])<span class="hljs-built_in">swap</span>(x,y);<br>	<span class="hljs-keyword">for</span>(rint dt=dis[x]-dis[y],i=<span class="hljs-number">0</span>;dt;i++,dt&gt;&gt;=<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">if</span>(dt&amp;<span class="hljs-number">1</span>)x=fp[x][i];<br>	<span class="hljs-keyword">if</span>(x==y)<span class="hljs-keyword">return</span> x;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">15</span>;~i;i--)<br>		<span class="hljs-keyword">if</span>(fp[x][i]!=fp[y][i])<br>			x=fp[x][i],y=fp[y][i];<br>	<span class="hljs-keyword">return</span> fp[x][<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		rint x,y;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y);<br>		<span class="hljs-built_in">Ins</span>(x,y);<span class="hljs-built_in">Ins</span>(y,x);<br>	&#125;<br>	inv[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)<br>		inv[i]=p<span class="hljs-number">-1ll</span>*p/i*inv[p%i]%p;<br>	<span class="hljs-built_in">getcir</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	rint r=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint x:vec)&#123;<br>		dis2[x]=++r;<br>		<span class="hljs-built_in">dfs</span>(x,x);<br>	&#125;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint x=<span class="hljs-number">1</span>;x&lt;=n;x++)&#123;<br>		<span class="hljs-keyword">for</span>(rint y=<span class="hljs-number">1</span>;y&lt;=n;y++)&#123;<br>			<span class="hljs-keyword">if</span>(col[x]==col[y])<br>				res+=inv[dis[x]+dis[y]<span class="hljs-number">-2</span>*dis[<span class="hljs-built_in">lca</span>(x,y)]+<span class="hljs-number">1</span>];<br>			<span class="hljs-keyword">else</span> &#123;<br>				rint dt=<span class="hljs-built_in">abs</span>(dis2[col[x]]-dis2[col[y]]);<br>				res+=inv[dis[x]+dis[y]+dt<span class="hljs-number">-1</span>];<br>				res+=inv[dis[x]+dis[y]+r-dt<span class="hljs-number">-1</span>];<br>				res-=inv[dis[x]+dis[y]+r<span class="hljs-number">-2</span>];<br>			&#125;<br>		&#125;<br>	&#125;<br>	res=(res%p+p)%p;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="染色"><a href="#染色" class="headerlink" title="染色"></a>染色</h1><blockquote>
<p>给定一个长度为 $n$ 的棋盘，要求对其染色，初始均为白色，要将某些格子染成黑色，有 $q$ 次询问，每次询问形如第 $x$ 个格子必须是白色，任意两个黑色格子之间的距离不小于 $k$，回答方案数对 $998244353$ 取模的结果。</p>
</blockquote>
<p>首先不难想到一个 $dp$ 的写法，定义 $dp_i$ 表示最后一个黑色格子在 $i$ 的方案数，转移是一个类似前缀和的东西，不过要特殊考虑第 $x$ 个点，这个看上去就不是很方便，把它单步容斥掉，用总的减去它是黑色的方案，不妨设 $solve(n,k)$ 表示 $n$ 个格子，任意两个黑色格子的距离不小于 $k$<br>的方案数，那么答案显然是<br>$$<br>solve(n,k)-solve(x-k-1,k)\times solve(n-x-k,k)<br>$$ </p>
<p>由于单次是 $O(n)$ 的并不能通过，所以考虑换一种做法，大概想到用组合数说不定可以推式子，那么考虑组合含义，可以钦定每个黑色格子之前必须放 $k-1$ 个白色格子，这样枚举黑色格子的个数，提前拿走若干白色格子，设有 $i$ 个黑色格子，不难得到答案是 $\binom{n-(i-1)(k-1)}{i}$，仔细思考一波后发现这个式子也不太好优化，考虑到它是 $O(n/k)$ 的，那么 $k$ 比较大的时候可以直接做，而对于 $k$ 比较小的情况可以分别跑一个 $dp$ 来预处理，所以最后时间复杂度是 $O(n\sqrt n)$ 。</p>
<p>想到的暴力不要轻易否定，说不定可以用来分治。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> S=<span class="hljs-number">220</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> ans[<span class="hljs-number">225</span>][N],fac[N],inv[N],dp[N],s[N];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Add</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x+=y;<span class="hljs-keyword">return</span> x&gt;=p?x-p:x;&#125;<br><span class="hljs-function">ll <span class="hljs-title">C</span><span class="hljs-params">(rint n,rint m)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;m)<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1ll</span>*fac[n]*inv[m]%p*inv[n-m]%p;<br>&#125;<br><span class="hljs-function">ll <span class="hljs-title">solve</span><span class="hljs-params">(rint n,rint k)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;=<span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(k&lt;=S)<span class="hljs-keyword">return</span> ans[k][n];<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n-i*k+k;i++)<br>		res+=<span class="hljs-built_in">C</span>(n-i*k+k,i);<br>	<span class="hljs-keyword">return</span> res%p;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	fac[<span class="hljs-number">0</span>]=fac[<span class="hljs-number">1</span>]=inv[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;N;i++)&#123;<br>		fac[i]=<span class="hljs-number">1ll</span>*fac[i<span class="hljs-number">-1</span>]*i%p;<br>		inv[i]=p<span class="hljs-number">-1ll</span>*p/i*inv[p%i]%p;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;N;i++)<br>		inv[i]=<span class="hljs-number">1ll</span>*inv[i<span class="hljs-number">-1</span>]*inv[i]%p;<br>	rint n,m;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=S;i++)&#123;<br>		ans[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=n;j++)&#123;<br>			<span class="hljs-keyword">if</span>(i+<span class="hljs-number">1</span>&lt;j)dp[j]=<span class="hljs-built_in">Add</span>(s[j-i<span class="hljs-number">-1</span>],<span class="hljs-number">1</span>);<br>			<span class="hljs-keyword">else</span> dp[j]=<span class="hljs-number">1</span>;<br>			ans[i][j]=<span class="hljs-built_in">Add</span>(s[j<span class="hljs-number">-1</span>],<span class="hljs-number">1</span>);<br>			ans[i][j]=<span class="hljs-built_in">Add</span>(ans[i][j],dp[j]);<br>			s[j]=<span class="hljs-built_in">Add</span>(s[j<span class="hljs-number">-1</span>],dp[j]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">while</span>(m--)&#123;<br>		rint x,k;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;k);--k;<br>		rll res=<span class="hljs-built_in">solve</span>(n,k)-<span class="hljs-built_in">solve</span>(x-k<span class="hljs-number">-1</span>,k)*<span class="hljs-built_in">solve</span>(n-x-k,k);<br>		res=(res%p+p)%p;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="林克卡特树"><a href="#林克卡特树" class="headerlink" title="林克卡特树"></a>林克卡特树</h1><blockquote>
<p>给定一棵 $n$ 个点的有根树，每个点有点权，每次随机选择一个点权不为 $0$ 的点，进行 $Access$ 操作，并将这个点的点权减一，直到所有点的点权为 $0$，求最后所有实链的长度的 $k$ 次方的期望 ，需要对于每次修改维护答案，一次修改是将某一个点权沿一条边移动 ，操作时并不真正去减点权 。</p>
</blockquote>
<p>首先考虑 $k=1$ 的做法，由于期望的线性，可以考虑每条边的贡献，定义 $a_u$ 表示 $u$ 点权，$c_u$ 表示以 $u$ 为根的子树中 $a$ 的和 ，考虑每个点的父亲边的贡献，设其父亲是 $fa$，如果这条边有贡献那么 $fa$ 的子树内最后一次 $Access$ 的操作是在 $u$ 的子树中，这个概率是 $\frac{c_u}{c_{fa}}$，考虑最后一个位置的取值有 $c_{fa}$ 种，合法的有 $c_u$ 种。</p>
<p>有这个概率后一些问题就比较清晰明了了，可以考虑做一个 $dp[u][j]$，表示以 $u$ 为根的实链的 $j$ 次方的期望值，那么每次转移的时候用二项式定理展开即可 ，显然可以套一个动态 $dp$ 去维护，也显然很恶心，并且显然过不去，对于使用二项式定理的 $dp$ 优化几乎没有，所以考虑换一个做法 。</p>
<p>不过貌似没有什么做法了，尝试一下直接枚举每条链的贡献，是</p>
<p>$$<br>(1-\frac{c_u}{c_{fa}})\frac{c_v}{c_u}(d_v-d_u)^k<br>$$</p>
<p>主要解释一下概率为什么是 $(1-\frac{c_u}{c_{fa}})\frac{a_v}{c_u}$，这两个看上去并不独立 。</p>
<p>事实上可以先考虑大的子树，要求最后一个点不能是 $u$ 的子树内的，再考虑小子树，最后一个点必须在 $v$ 上边，注意到这样考虑是满足上述式子的，而如果先考虑小子树就不满足这个了，注意是看上去不满足，实际是满足的，原因是小子树要考虑的东西比较多，因为如果先确定小子树，那么大子树的排列方案并不能直接算，而是一个类似可重集的排列的东西，所以其实也满足。</p>
<p>这样的话拆一下式子，是</p>
<p>$$<br>\sum_{i=0}^k\binom{k}{i}(-1)^i(\frac{1}{c_u}-\frac{1}{c_{fa}})\frac{1}{c_u}d_u^id_v^{k-i}a_v<br>$$</p>
<p>可以对于含有 $u$ 的项和含有 $v$ 的项分别处理，注意对于 $fa$ 的单独维护 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">998244353</span>;<br><span class="hljs-function">ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;<br>	e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>&#125;<br><span class="hljs-type">int</span> a[N],siz[N],siz2[N],d[N],fa[N],dfn[N],Time;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs1</span><span class="hljs-params">(rint u)</span></span>&#123;<br>	siz[u]=a[u];dfn[u]=++Time;siz2[u]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa[u])<span class="hljs-keyword">continue</span>;<br>		fa[v]=u;<br>		d[v]=d[u]+<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">dfs1</span>(v);<br>		siz[u]+=siz[v];<br>		siz2[u]+=siz2[v];<br>	&#125;<br>&#125;<br><span class="hljs-type">int</span> n,m,k;<br>ll res,C[<span class="hljs-number">20</span>][<span class="hljs-number">20</span>];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Add</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x+=y;<span class="hljs-keyword">return</span> x&gt;=p?x-p:x;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">Del</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;x-=y;<span class="hljs-keyword">return</span> x&gt;=<span class="hljs-number">0</span>?x:x+p;&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> val[<span class="hljs-number">11</span>];<br>	<span class="hljs-built_in">Node</span>()&#123;<span class="hljs-built_in">memset</span>(val,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(val));&#125;<br>	<span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> += (<span class="hljs-type">const</span> Node&amp;A)&#123;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=k;i++)<br>			val[i]=<span class="hljs-built_in">Add</span>(val[i],A.val[i]);<br>	&#125;<br>	Node <span class="hljs-keyword">operator</span> + (<span class="hljs-type">const</span> Node&amp;A)<span class="hljs-type">const</span>&#123;<br>		Node res=*<span class="hljs-keyword">this</span>;res+=A;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	<span class="hljs-keyword">friend</span> Node <span class="hljs-keyword">operator</span> ~ (<span class="hljs-type">const</span> Node&amp;A)&#123;<br>		Node res;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=k;i++)<br>			res.val[i]=<span class="hljs-built_in">Del</span>(<span class="hljs-number">0</span>,A.val[i]);<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>&#125;f1[N],f2[N],g[N],tr1[N],tr2[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update1</span><span class="hljs-params">(rint x,Node v)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(;x&lt;=n;x+=x&amp;-x)<br>		tr1[x]+=v;<br>&#125;<br><span class="hljs-function">Node <span class="hljs-title">query1</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	Node res;<br>	<span class="hljs-keyword">for</span>(;x;x&amp;=x<span class="hljs-number">-1</span>)<br>		res+=tr1[x];<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update2</span><span class="hljs-params">(rint x,Node v)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(;x&lt;=n;x+=x&amp;-x)<br>		tr2[x]+=v;<br>&#125;<br><span class="hljs-function">Node <span class="hljs-title">query2</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	Node res;<br>	<span class="hljs-keyword">for</span>(;x;x&amp;=x<span class="hljs-number">-1</span>)<br>		res+=tr2[x];<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-type">int</span> inv[N],pw[N][<span class="hljs-number">11</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(rint u)</span></span>&#123;<br>	inv[u]=<span class="hljs-built_in">fpow</span>(siz[u],p<span class="hljs-number">-2</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=k;i++)&#123;<br>		f1[u].val[i]=<span class="hljs-number">1ll</span>*pw[d[u]][i]*inv[u]%p;<br>		f2[u].val[i]=<span class="hljs-number">1ll</span>*pw[d[u]+<span class="hljs-number">1</span>][i]*(p-inv[u])%p;<br>		g[u].val[i]=<span class="hljs-number">1ll</span>*pw[d[u]][i]*a[u]%p;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa[u])<span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">dfs2</span>(v);<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">10</span>;i++)&#123;<br>		C[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=i;j++)<br>			C[i][j]=(C[i<span class="hljs-number">-1</span>][j]+C[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>])%p;<br>	&#125;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;n,&amp;m,&amp;k);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=n+<span class="hljs-number">1</span>;i++)&#123;<br>		pw[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=k;j++)<br>			pw[i][j]=<span class="hljs-number">1ll</span>*pw[i][j<span class="hljs-number">-1</span>]*i%p;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		rint x,y;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y);<br>		<span class="hljs-built_in">Ins</span>(x,y);<span class="hljs-built_in">Ins</span>(y,x);<br>	&#125;<br>	<span class="hljs-built_in">dfs1</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint u=<span class="hljs-number">1</span>;u&lt;=n;u++)&#123;<br>		<span class="hljs-built_in">update1</span>(dfn[u],f1[u]);<br>		<span class="hljs-built_in">update1</span>(dfn[u]+siz2[u],~f1[u]);<br>		<span class="hljs-built_in">update1</span>(dfn[u]+<span class="hljs-number">1</span>,f2[u]);<br>		<span class="hljs-built_in">update1</span>(dfn[u]+siz2[u],~f2[u]);<br>		<span class="hljs-built_in">update2</span>(dfn[u],g[u]);<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		Node now=<span class="hljs-built_in">query1</span>(dfn[i]);<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>			res+=C[k][j]*now.val[j]%p*g[i].val[k-j]%p*pw;<br>	&#125;<br>	res=(res%p+p)%p;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	<span class="hljs-keyword">while</span>(m--)&#123;<br>		rint x,y;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y);<br>		Node now=<span class="hljs-built_in">query1</span>(dfn[x]);<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>			res-=C[k][j]*now.val[j]%p*g[x].val[k-j]%p*pw;<br>		now=<span class="hljs-built_in">query1</span>(dfn[y]);<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>			res-=C[k][j]*now.val[j]%p*g[y].val[k-j]%p*pw;<br>		<span class="hljs-keyword">if</span>(fa[x]==y)&#123;<br>			now=<span class="hljs-built_in">query2</span>(dfn[x]+siz2[x]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[x]<span class="hljs-number">-1</span>));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res-=C[k][j]*f1[x].val[j]%p*now.val[k-j]%p*pw;<br>			now=<span class="hljs-built_in">query2</span>(dfn[x]+siz2[x]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[x]));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res-=C[k][j]*f2[x].val[j]%p*now.val[k-j]%p*pw;<br>			siz[x]--;a[x]--;a[y]++;<br>			inv[x]=<span class="hljs-built_in">fpow</span>(siz[x],p<span class="hljs-number">-2</span>);<br>			<span class="hljs-built_in">update1</span>(dfn[x],~f1[x]);<br>			<span class="hljs-built_in">update1</span>(dfn[x]+siz2[x],f1[x]);<br>			<span class="hljs-built_in">update1</span>(dfn[x]+<span class="hljs-number">1</span>,~f2[x]);<br>			<span class="hljs-built_in">update1</span>(dfn[x]+siz2[x],f2[x]);<br>			<span class="hljs-built_in">update2</span>(dfn[x],~g[x]);<br>			<span class="hljs-built_in">update2</span>(dfn[y],~g[y]);<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=k;i++)&#123;<br>				f1[x].val[i]=<span class="hljs-number">1ll</span>*pw[d[x]][i]*inv[x]%p;<br>				f2[x].val[i]=<span class="hljs-number">1ll</span>*pw[d[x]+<span class="hljs-number">1</span>][i]*(p-inv[x])%p;<br>				g[x].val[i]=<span class="hljs-number">1ll</span>*pw[d[x]][i]*a[x]%p;<br>				g[y].val[i]=<span class="hljs-number">1ll</span>*pw[d[y]][i]*a[y]%p;<br>			&#125;<br>			<span class="hljs-built_in">update1</span>(dfn[x],f1[x]);<br>			<span class="hljs-built_in">update1</span>(dfn[x]+siz2[x],~f1[x]);<br>			<span class="hljs-built_in">update1</span>(dfn[x]+<span class="hljs-number">1</span>,f2[x]);<br>			<span class="hljs-built_in">update1</span>(dfn[x]+siz2[x],~f2[x]);<br>			<span class="hljs-built_in">update2</span>(dfn[x],g[x]);<br>			<span class="hljs-built_in">update2</span>(dfn[y],g[y]);<br>			now=<span class="hljs-built_in">query2</span>(dfn[x]+siz2[x]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[x]<span class="hljs-number">-1</span>));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res+=C[k][j]*f1[x].val[j]%p*now.val[k-j]%p*pw;<br>			now=<span class="hljs-built_in">query2</span>(dfn[x]+siz2[x]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[x]));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res+=C[k][j]*f2[x].val[j]%p*now.val[k-j]%p*pw;<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			now=<span class="hljs-built_in">query2</span>(dfn[y]+siz2[y]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[y]<span class="hljs-number">-1</span>));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res-=C[k][j]*f1[y].val[j]%p*now.val[k-j]%p*pw;<br>			now=<span class="hljs-built_in">query2</span>(dfn[y]+siz2[y]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[y]));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res-=C[k][j]*f2[y].val[j]%p*now.val[k-j]%p*pw;<br>			siz[y]++;a[x]--;a[y]++;<br>			inv[y]=<span class="hljs-built_in">fpow</span>(siz[y],p<span class="hljs-number">-2</span>);<br>			<span class="hljs-built_in">update1</span>(dfn[y],~f1[y]);<br>			<span class="hljs-built_in">update1</span>(dfn[y]+siz2[y],f1[y]);<br>			<span class="hljs-built_in">update1</span>(dfn[y]+<span class="hljs-number">1</span>,~f2[y]);<br>			<span class="hljs-built_in">update1</span>(dfn[y]+siz2[y],f2[y]);<br>			<span class="hljs-built_in">update2</span>(dfn[x],~g[x]);<br>			<span class="hljs-built_in">update2</span>(dfn[y],~g[y]);<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=k;i++)&#123;<br>				f1[y].val[i]=<span class="hljs-number">1ll</span>*pw[d[y]][i]*inv[y]%p;<br>				f2[y].val[i]=<span class="hljs-number">1ll</span>*pw[d[y]+<span class="hljs-number">1</span>][i]*(p-inv[y])%p;<br>				g[x].val[i]=<span class="hljs-number">1ll</span>*pw[d[x]][i]*a[x]%p;<br>				g[y].val[i]=<span class="hljs-number">1ll</span>*pw[d[y]][i]*a[y]%p;<br>			&#125;<br>			<span class="hljs-built_in">update1</span>(dfn[y],f1[y]);<br>			<span class="hljs-built_in">update1</span>(dfn[y]+siz2[y],~f1[y]);<br>			<span class="hljs-built_in">update1</span>(dfn[y]+<span class="hljs-number">1</span>,f2[y]);<br>			<span class="hljs-built_in">update1</span>(dfn[y]+siz2[y],~f2[y]);<br>			<span class="hljs-built_in">update2</span>(dfn[x],g[x]);<br>			<span class="hljs-built_in">update2</span>(dfn[y],g[y]);<br>			now=<span class="hljs-built_in">query2</span>(dfn[y]+siz2[y]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[y]<span class="hljs-number">-1</span>));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res+=C[k][j]*f1[y].val[j]%p*now.val[k-j]%p*pw;<br>			now=<span class="hljs-built_in">query2</span>(dfn[y]+siz2[y]<span class="hljs-number">-1</span>)+(~<span class="hljs-built_in">query2</span>(dfn[y]));<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>				res+=C[k][j]*f2[y].val[j]%p*now.val[k-j]%p*pw;<br>		&#125;<br>		now=<span class="hljs-built_in">query1</span>(dfn[x]);<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>			res+=C[k][j]*now.val[j]%p*g[x].val[k-j]%p*pw;<br>		now=<span class="hljs-built_in">query1</span>(dfn[y]);<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;j&lt;=k;j++,pw=-pw)<br>			res+=C[k][j]*now.val[j]%p*g[y].val[k-j]%p*pw;<br>		res=(res%p+p)%p;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="异或粽子"><a href="#异或粽子" class="headerlink" title="异或粽子"></a>异或粽子</h1><blockquote>
<p>每个点有一个取值区间 $[0,a_i]$ ，支持两种操作，第一种是令 $a_x=y$，第二种是询问区间 $[l,r]$ 的点的所有取值方案中，有多少的异或和在 $[L,R]$ 中 。</p>
</blockquote>
<p>考虑一个暴力的做法，对于每次转移相当于做一个异或卷积，所以在值域比较小的时候可以直接维护 $FWT$ 数组的区间积 。</p>
<p>但是值域如果比较大就不太行了，考虑如何不把值域加到 $dp$ 的状态里边，注意到一直没有用到前缀和的性质，不过也确实不知道前缀和的性质，题解给出了一个十分强大的性质，不过貌似也比较显然，对于一个值域区间 $[c2^k,(c+1)2^k-1]$，一个数异或上这个区间得到的还是一个长度相同的值域区间，并且区间的左右端点只有高于第 $k$ 位的位置会改变，考虑为什么，原因是对于前 $k$ 位，区间中包含了前 $k$ 位的所有取值，在这种情况下异或是封闭的，所以只有高于第 $k$ 位会改变 。</p>
<p>根据上边的性质，两个区间异或起来得到的还是一个区间，并且长度是原来较长的那个，所以我们实际上只需要把每个 $a_i$ 划分成若干个区间，然后每次在一个位置选择一个区间进行异或，这样的话只需要知道异或的区间的最大值，就能够知道最后值域区间的最大值，所以可以直接枚举这个最大值，考虑怎么得到值域范围的其它值，首先找一个划分区间的办法，可以将 $a_i$ 加上一，然后二进制分解，注意分的区间要从大到小，因为要保证它始终是 $[c2^k,(c+1)2^k-1]$ 这样的区间，这样的话划分出来的区间，除了前 $k+1$ 位，剩下的肯定是 $a_i+1$ 二进制的一个前缀，所以除了前 $k+1$ 位的异或和是可以直接得到的，而前 $k$ 位也是确定的，只需要考虑第 $k+1$ 位，发现这是一个类似异或卷积的东西，直接用线段树维护即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">const</span> ll inv=p+<span class="hljs-number">1</span>&gt;&gt;<span class="hljs-number">1</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> l,r,k;<br>&#125;;<br>vector&lt;Node&gt; vec[N];<br><span class="hljs-type">int</span> a[N],bit=<span class="hljs-number">1</span>,now;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getd</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	vec[x].<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">30</span>,now=<span class="hljs-number">0</span>;~i;i--)<br>		<span class="hljs-keyword">if</span>(a[x]&gt;&gt;i&amp;<span class="hljs-number">1</span>)vec[x].<span class="hljs-built_in">push_back</span>((Node)&#123;now,now+(<span class="hljs-number">1</span>&lt;&lt;i)<span class="hljs-number">-1</span>,i&#125;),now+=<span class="hljs-number">1</span>&lt;&lt;i;<br>	<span class="hljs-built_in">reverse</span>(vec[x].<span class="hljs-built_in">begin</span>(),vec[x].<span class="hljs-built_in">end</span>());<br>&#125;<br><span class="hljs-type">int</span> dp1[N&lt;&lt;<span class="hljs-number">2</span>][<span class="hljs-number">32</span>][<span class="hljs-number">2</span>],dp2[N&lt;&lt;<span class="hljs-number">2</span>][<span class="hljs-number">32</span>][<span class="hljs-number">2</span>],sum[N&lt;&lt;<span class="hljs-number">2</span>],dp[<span class="hljs-number">32</span>][<span class="hljs-number">2</span>],_dp[<span class="hljs-number">32</span>][<span class="hljs-number">2</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">upd</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	sum[bit+x]=a[x];<br>	<span class="hljs-built_in">getd</span>(x);<br>	rll s=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>,j=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">30</span>;i++)&#123;<br>		dp1[bit+x][i][<span class="hljs-number">0</span>]=dp1[bit+x][i][<span class="hljs-number">1</span>]=<span class="hljs-number">0</span>;<br>		dp2[bit+x][i][<span class="hljs-number">0</span>]=dp2[bit+x][i][<span class="hljs-number">1</span>]=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">while</span>(j&lt;vec[x].<span class="hljs-built_in">size</span>()&amp;&amp;vec[x][j].k&lt;i)s+=vec[x][j].r-vec[x][j].l+<span class="hljs-number">1</span>,j++;<br>		dp1[bit+x][i][a[x]&gt;&gt;i&amp;<span class="hljs-number">1</span>]=s%p;<br>		dp2[bit+x][i][a[x]&gt;&gt;i&amp;<span class="hljs-number">1</span>]=s%p;<br>		<span class="hljs-keyword">if</span>(j&lt;vec[x].<span class="hljs-built_in">size</span>()&amp;&amp;vec[x][j].k==i)&#123;<br>			s+=vec[x][j].r-vec[x][j].l+<span class="hljs-number">1</span>;<br>			dp1[bit+x][i][<span class="hljs-number">0</span>]=(dp1[bit+x][i][<span class="hljs-number">0</span>]+vec[x][j].r-vec[x][j].l+<span class="hljs-number">1</span>)%p;<br>			j++;<br>		&#125;<br>		rll d0=dp1[bit+x][i][<span class="hljs-number">0</span>],d1=dp1[bit+x][i][<span class="hljs-number">1</span>];<br>		dp1[bit+x][i][<span class="hljs-number">0</span>]=(d0+d1)%p;<br>		dp1[bit+x][i][<span class="hljs-number">1</span>]=(d0+p-d1)%p;<br>		d0=dp2[bit+x][i][<span class="hljs-number">0</span>],d1=dp2[bit+x][i][<span class="hljs-number">1</span>];<br>		dp2[bit+x][i][<span class="hljs-number">0</span>]=(d0+d1)%p;<br>		dp2[bit+x][i][<span class="hljs-number">1</span>]=(d0+p-d1)%p;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">up</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	sum[x]=sum[x&lt;&lt;<span class="hljs-number">1</span>]^sum[x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>];<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">30</span>;i++)&#123;<br>		dp1[x][i][<span class="hljs-number">0</span>]=<span class="hljs-number">1ll</span>*dp1[x&lt;&lt;<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]*dp1[x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]%p;<br>		dp1[x][i][<span class="hljs-number">1</span>]=<span class="hljs-number">1ll</span>*dp1[x&lt;&lt;<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]*dp1[x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]%p;<br>		dp2[x][i][<span class="hljs-number">0</span>]=<span class="hljs-number">1ll</span>*dp2[x&lt;&lt;<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]*dp2[x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]%p;<br>		dp2[x][i][<span class="hljs-number">1</span>]=<span class="hljs-number">1ll</span>*dp2[x&lt;&lt;<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]*dp2[x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]%p;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(rint n)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(;bit&lt;=n;bit&lt;&lt;=<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<span class="hljs-built_in">upd</span>(i);<br>	<span class="hljs-keyword">for</span>(rint i=bit<span class="hljs-number">-1</span>;i;i--)<span class="hljs-built_in">up</span>(i);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(rint x,rint v)</span></span>&#123;<span class="hljs-keyword">for</span>(a[x]=v,<span class="hljs-built_in">upd</span>(x),x+=bit,x&gt;&gt;=<span class="hljs-number">1</span>;x;x&gt;&gt;=<span class="hljs-number">1</span>)<span class="hljs-built_in">up</span>(x);&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">query</span><span class="hljs-params">(rint l,rint r)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(l+=bit<span class="hljs-number">-1</span>,r+=bit+<span class="hljs-number">1</span>;l^r^<span class="hljs-number">1</span>;l&gt;&gt;=<span class="hljs-number">1</span>,r&gt;&gt;=<span class="hljs-number">1</span>)&#123;<br>		<span class="hljs-keyword">if</span>(~l&amp;<span class="hljs-number">1</span>)&#123;<br>			now^=sum[l^<span class="hljs-number">1</span>];<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">30</span>;i++)&#123;<br>				dp[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1ll</span>*dp[i][<span class="hljs-number">0</span>]*dp1[l^<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]%p;<br>				dp[i][<span class="hljs-number">1</span>]=<span class="hljs-number">1ll</span>*dp[i][<span class="hljs-number">1</span>]*dp1[l^<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]%p;<br>				_dp[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1ll</span>*_dp[i][<span class="hljs-number">0</span>]*dp2[l^<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]%p;<br>				_dp[i][<span class="hljs-number">1</span>]=<span class="hljs-number">1ll</span>*_dp[i][<span class="hljs-number">1</span>]*dp2[l^<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]%p;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">if</span>(r&amp;<span class="hljs-number">1</span>)&#123;<br>			now^=sum[r^<span class="hljs-number">1</span>];<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">30</span>;i++)&#123;<br>				dp[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1ll</span>*dp[i][<span class="hljs-number">0</span>]*dp1[r^<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]%p;<br>				dp[i][<span class="hljs-number">1</span>]=<span class="hljs-number">1ll</span>*dp[i][<span class="hljs-number">1</span>]*dp1[r^<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]%p;<br>				_dp[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1ll</span>*_dp[i][<span class="hljs-number">0</span>]*dp2[r^<span class="hljs-number">1</span>][i][<span class="hljs-number">0</span>]%p;<br>				_dp[i][<span class="hljs-number">1</span>]=<span class="hljs-number">1ll</span>*_dp[i][<span class="hljs-number">1</span>]*dp2[r^<span class="hljs-number">1</span>][i][<span class="hljs-number">1</span>]%p;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">30</span>;i++)&#123;<br>		rint d0=dp[i][<span class="hljs-number">0</span>],d1=dp[i][<span class="hljs-number">1</span>];<br>		dp[i][<span class="hljs-number">0</span>]=(d0+d1)*inv%p;<br>		dp[i][<span class="hljs-number">1</span>]=(d0-d1+p)*inv%p;<br>		d0=_dp[i][<span class="hljs-number">0</span>],d1=_dp[i][<span class="hljs-number">1</span>];<br>		_dp[i][<span class="hljs-number">0</span>]=(d0+d1)*inv%p;<br>		_dp[i][<span class="hljs-number">1</span>]=(d0-d1+p)*inv%p;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n,m;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]),a[i]++;<br>	<span class="hljs-built_in">build</span>(n);<br>	<span class="hljs-keyword">while</span>(m--)&#123;<br>		rint opt,l,r;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;opt,&amp;l,&amp;r);<br>		<span class="hljs-keyword">if</span>(opt==<span class="hljs-number">1</span>)&#123;<br>			<span class="hljs-built_in">update</span>(l,r+<span class="hljs-number">1</span>);<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			rint L,R;<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;L,&amp;R);<br>			now=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">30</span>;i++)<br>				dp[i][<span class="hljs-number">0</span>]=_dp[i][<span class="hljs-number">0</span>]=dp[i][<span class="hljs-number">1</span>]=_dp[i][<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>			<span class="hljs-built_in">query</span>(l,r);<br>			rll res=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span>(rint s=<span class="hljs-number">0</span>,pw=<span class="hljs-number">1</span>;s&lt;=<span class="hljs-number">30</span>;s++,pw=pw*inv%p)&#123;<br>				rint t=now;<br>				now&gt;&gt;=s+<span class="hljs-number">1</span>;now&lt;&lt;=s+<span class="hljs-number">1</span>;<br>				rll len1=<span class="hljs-built_in">min</span>(R,now|((<span class="hljs-number">1</span>&lt;&lt;s)<span class="hljs-number">-1</span>))-<span class="hljs-built_in">max</span>(L,now)+<span class="hljs-number">1</span>,len2=<span class="hljs-built_in">min</span>(R,now|((<span class="hljs-number">1</span>&lt;&lt;s+<span class="hljs-number">1</span>)<span class="hljs-number">-1</span>))-<span class="hljs-built_in">max</span>(L,now|(<span class="hljs-number">1</span>&lt;&lt;s))+<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">if</span>(len1&gt;<span class="hljs-number">0</span>)res+=(dp[s][<span class="hljs-number">0</span>]-_dp[s][<span class="hljs-number">0</span>])*len1%p*pw%p;<br>				<span class="hljs-keyword">if</span>(len2&gt;<span class="hljs-number">0</span>)res+=(dp[s][<span class="hljs-number">1</span>]-_dp[s][<span class="hljs-number">1</span>])*len2%p*pw%p;<br>				now=t;<br>			&#125;<br>			res=(res%p+p)%p;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="树-1"><a href="#树-1" class="headerlink" title="树"></a>树</h1><p>题面略长。</p>
<p>首先发现 $A$，$B$ 不喜欢的正好相反，并且互为补集，所以可以把 $A$ 不喜欢的转化一下答案，设 $a_x$ 表示与 $x$ 是祖先关系并且比 $w_x$ 小的点的个数，设 $b_x$ 表示在 $x$ 的子树中并且比 $w_x$ 大的个数，$d_x$ 表示深度，如果没有权值相等的点，那么贡献是十分好算的，即 $d_x-a_x-b_x$。</p>
<p>考虑如果有权值相等的点，一个点的贡献要额外减去它祖先中和它权值一样的点，这导致我们不太好贪心，尝试证明一个点的祖先一定比它先选，设 $u$ 是 $v$ 的祖先，那么一定有 $a_v-a_u&lt;d_v-d_u$ 和 $b_u\ge b_v$，所以可以得到先选祖先一定是最优的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">5e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> Max=<span class="hljs-number">5e5</span>;<br><span class="hljs-type">const</span> ll INF=<span class="hljs-number">1e15</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;<br>	e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>&#125;<br><span class="hljs-type">int</span> n,w[N],d[N],dfn[N],siz[N],tr[N],Time;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(rint x,rint v)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(;x&lt;=Max;x+=x&amp;-x)<br>		tr[x]+=v;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(rint x)</span></span>&#123;<br>	rint res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(;x;x&amp;=x<span class="hljs-number">-1</span>)<br>		res+=tr[x];<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-type">int</span> A[N],B[N],C[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint u,rint fa)</span></span>&#123;<br>	siz[u]=<span class="hljs-number">1</span>;dfn[u]=++Time;<br>	A[u]=<span class="hljs-built_in">query</span>(w[u]<span class="hljs-number">-1</span>);<br>	C[u]=<span class="hljs-built_in">query</span>(w[u])-A[u];<br>	<span class="hljs-built_in">update</span>(w[u],<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa)<span class="hljs-keyword">continue</span>;<br>		d[v]=d[u]+<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">dfs</span>(v,u);<br>		siz[u]+=siz[v];<br>	&#125;<br>	<span class="hljs-built_in">update</span>(w[u],<span class="hljs-number">-1</span>);<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> x,y;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (<span class="hljs-type">const</span> Node&amp;A)<span class="hljs-type">const</span>&#123;<br>		<span class="hljs-keyword">return</span> y&gt;A.y;<br>	&#125;<br>&#125;seq[N];<br><span class="hljs-type">char</span> buf[<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>],*p1,*p2;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">gc</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">return</span> p1==p2?p2=buf+<span class="hljs-built_in">fread</span>(p1=buf,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>,stdin),p1==p2?EOF:*p1++:*p1++;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>&#123;<br>	rint x=<span class="hljs-number">0</span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">gc</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-string">&#x27;0&#x27;</span>||ch&gt;<span class="hljs-string">&#x27;9&#x27;</span>)ch=<span class="hljs-built_in">gc</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;ch&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)x=x*<span class="hljs-number">10</span>+ch-<span class="hljs-string">&#x27;0&#x27;</span>,ch=<span class="hljs-built_in">gc</span>();<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br>ll ans[N];<br><span class="hljs-type">int</span> q[N];<br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cmp</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;<br>	<span class="hljs-keyword">return</span> d[x]-A[x]-B[x]-C[x]&gt;d[y]-A[y]-B[y]-C[y];<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	n=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		w[i]=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		rint x=<span class="hljs-built_in">read</span>(),y=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-built_in">Ins</span>(x,y);<span class="hljs-built_in">Ins</span>(y,x);<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		seq[i]=(Node)&#123;i,w[i]&#125;;<br>	<span class="hljs-built_in">sort</span>(seq+<span class="hljs-number">1</span>,seq+n+<span class="hljs-number">1</span>);<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>,j=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		<span class="hljs-keyword">while</span>(j&lt;=n&amp;&amp;seq[j].y&gt;seq[i].y)<br>			<span class="hljs-built_in">update</span>(dfn[seq[j].x],<span class="hljs-number">1</span>),j++;<br>		rint t=<span class="hljs-built_in">query</span>(dfn[seq[i].x]+siz[seq[i].x]<span class="hljs-number">-1</span>)-<span class="hljs-built_in">query</span>(dfn[seq[i].x]);<br>		res+=A[i];B[seq[i].x]=t;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		q[i]=i;<br>	<span class="hljs-built_in">sort</span>(q+<span class="hljs-number">1</span>,q+n+<span class="hljs-number">1</span>,cmp);<br>	ans[n]=res;<br>	<span class="hljs-keyword">for</span>(rint i=n,cnt=<span class="hljs-number">1</span>;i;i--,cnt++)&#123;<br>		res+=d[q[i]]-A[q[i]]-B[q[i]]-C[q[i]];<br>		ans[i<span class="hljs-number">-1</span>]=<span class="hljs-number">1ll</span>*cnt*(cnt<span class="hljs-number">-1</span>)/<span class="hljs-number">2</span>+res;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans[i]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="数学"><a href="#数学" class="headerlink" title="数学"></a>数学</h1><blockquote>
<p>定义一个数是好的当且进当存在三个连续数位满足单调上升，求一个前缀 $1-n$ 满足前缀中的数中好的数占比不少于 $p$ 。</p>
</blockquote>
<p>给出一个结论，对于 $\frac{B}A&lt;p$，每次找到一个最小的 $C$ 满足 $\frac{B+C}{A+C}\ge p$，一直迭代知道找到答案，迭代次数不超过 $log$，所以直接大力模拟即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> db double</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">110</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> w=<span class="hljs-number">1e9</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	ll a[N];<br>	Node <span class="hljs-keyword">operator</span> + (<span class="hljs-type">const</span> Node&amp;A)<span class="hljs-type">const</span>&#123;<br>		Node res=*<span class="hljs-keyword">this</span>;<br>		res.a[<span class="hljs-number">0</span>]=<span class="hljs-built_in">max</span>(res.a[<span class="hljs-number">0</span>],A.a[<span class="hljs-number">0</span>]);<br>		rint t=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=res.a[<span class="hljs-number">0</span>];i++)&#123;<br>			res.a[i]+=A.a[i]+t;<br>			t=res.a[i]/w;<br>			res.a[i]%=w;<br>		&#125;<br>		<span class="hljs-keyword">if</span>(t)res.a[++res.a[<span class="hljs-number">0</span>]]=t;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	Node <span class="hljs-keyword">operator</span> - (<span class="hljs-type">const</span> Node&amp;A)<span class="hljs-type">const</span>&#123;<br>		Node res=*<span class="hljs-keyword">this</span>;<br>		res.a[<span class="hljs-number">0</span>]=<span class="hljs-built_in">max</span>(res.a[<span class="hljs-number">0</span>],A.a[<span class="hljs-number">0</span>]);<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=res.a[<span class="hljs-number">0</span>];i++)&#123;<br>			res.a[i]-=A.a[i];<br>			<span class="hljs-keyword">if</span>(res.a[i]&lt;<span class="hljs-number">0</span>)res.a[i]+=w,res.a[i+<span class="hljs-number">1</span>]--;<br>		&#125;<br>		<span class="hljs-keyword">while</span>(!res.a[res.a[<span class="hljs-number">0</span>]]&amp;&amp;res.a[<span class="hljs-number">0</span>]&gt;<span class="hljs-number">1</span>)res.a[<span class="hljs-number">0</span>]--;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	Node <span class="hljs-keyword">operator</span> * (<span class="hljs-type">const</span> <span class="hljs-type">int</span>&amp;A)<span class="hljs-type">const</span>&#123;<br>		Node res=*<span class="hljs-keyword">this</span>;<br>		rint t=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=res.a[<span class="hljs-number">0</span>];i++)&#123;<br>			res.a[i]=res.a[i]*A+t;<br>			t=res.a[i]/w;<br>			res.a[i]%=w;<br>		&#125;<br>		<span class="hljs-keyword">if</span>(t)res.a[++res.a[<span class="hljs-number">0</span>]]=t;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	Node <span class="hljs-keyword">operator</span> / (<span class="hljs-type">const</span> <span class="hljs-type">int</span>&amp;A)<span class="hljs-type">const</span>&#123;<br>		Node res=*<span class="hljs-keyword">this</span>;<br>		rll t=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(rint i=res.a[<span class="hljs-number">0</span>];i;i--)&#123;<br>			res.a[i]+=t;<br>			t=(res.a[i]%A)*w;<br>			res.a[i]/=A;<br>		&#125;<br>		<span class="hljs-keyword">if</span>(t)res.a[<span class="hljs-number">1</span>]++;<br>		<span class="hljs-keyword">while</span>(!res.a[res.a[<span class="hljs-number">0</span>]]&amp;&amp;res.a[<span class="hljs-number">0</span>]&gt;<span class="hljs-number">1</span>)res.a[<span class="hljs-number">0</span>]--;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (<span class="hljs-type">const</span> Node&amp;A)<span class="hljs-type">const</span>&#123;<br>		<span class="hljs-keyword">if</span>(a[<span class="hljs-number">0</span>]!=A.a[<span class="hljs-number">0</span>])<span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>]&lt;A.a[<span class="hljs-number">0</span>];<br>		<span class="hljs-keyword">for</span>(rint i=a[<span class="hljs-number">0</span>];i;i--)&#123;<br>			<span class="hljs-keyword">if</span>(a[i]&lt;A.a[i])<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">if</span>(a[i]&gt;A.a[i])<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span>&#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld&quot;</span>,a[a[<span class="hljs-number">0</span>]]);<br>		<span class="hljs-keyword">for</span>(rint i=a[<span class="hljs-number">0</span>]<span class="hljs-number">-1</span>;i;i--)<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%09lld&quot;</span>,a[i]);<br>	&#125;<br>&#125;A,B,dp[N][<span class="hljs-number">10</span>][<span class="hljs-number">10</span>][<span class="hljs-number">2</span>],val1,val0;<br><span class="hljs-type">int</span> num[N],p1,p2,tt;<br><span class="hljs-type">bool</span> vis[N][<span class="hljs-number">10</span>][<span class="hljs-number">10</span>][<span class="hljs-number">2</span>];<br><span class="hljs-function">Node <span class="hljs-title">dfs</span><span class="hljs-params">(rint hh,rint v1,rint v2,rint lim1,rint lim2,rint ok)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(!hh)<span class="hljs-keyword">return</span> ok?val1:val0;<br>	<span class="hljs-keyword">if</span>(!lim1&amp;&amp;!lim2&amp;&amp;vis[hh][v1][v2][ok])<span class="hljs-keyword">return</span> dp[hh][v1][v2][ok];<br>	Node t=val0;<br>	rint lim=lim1?num[hh]:<span class="hljs-number">9</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=lim;i++)&#123;<br>		<span class="hljs-keyword">if</span>(lim2)t=t+<span class="hljs-built_in">dfs</span>(hh<span class="hljs-number">-1</span>,v2,i,lim1&amp;&amp;i==lim,v2==<span class="hljs-number">0</span>,ok);<br>		<span class="hljs-keyword">else</span> t=t+<span class="hljs-built_in">dfs</span>(hh<span class="hljs-number">-1</span>,v2,i,lim1&amp;&amp;i==lim,<span class="hljs-number">0</span>,ok|(v1&lt;v2&amp;&amp;v2&lt;i));<br>	&#125;<br>	<span class="hljs-keyword">if</span>(!lim1&amp;&amp;!lim2)vis[hh][v1][v2][ok]=<span class="hljs-number">1</span>,dp[hh][v1][v2][ok]=t;<br>	<span class="hljs-keyword">return</span> t;<br>&#125;<br><span class="hljs-function">Node <span class="hljs-title">solve</span><span class="hljs-params">(Node n)</span></span>&#123;<br>	tt=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n.a[<span class="hljs-number">0</span>];i++)&#123;<br>		<span class="hljs-keyword">if</span>(i==n.a[<span class="hljs-number">0</span>])&#123;<br>			<span class="hljs-keyword">while</span>(n.a[i])<br>				num[++tt]=n.a[i]%<span class="hljs-number">10</span>,n.a[i]/=<span class="hljs-number">10</span>;<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">9</span>;j++)<br>				num[++tt]=n.a[i]%<span class="hljs-number">10</span>,n.a[i]/=<span class="hljs-number">10</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">dfs</span>(tt,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	db p;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%lf&quot;</span>,&amp;p);<br>	p1=p*<span class="hljs-number">100000</span>+<span class="hljs-number">0.5</span>;p2=<span class="hljs-number">100000</span>;<br>	A.a[<span class="hljs-number">0</span>]=B.a[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;A.a[<span class="hljs-number">1</span>]=<span class="hljs-number">100</span>;<br>	val0.a[<span class="hljs-number">0</span>]=val1.a[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;val1.a[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">while</span>(B*p2&lt;A*p1)&#123;<br>		Node C=(A*p1-B*p2)/(p2-p1);<br>		A=A+C;B=<span class="hljs-built_in">solve</span>(A);<br>	&#125;<br>	A.<span class="hljs-built_in">print</span>();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="城市大脑"><a href="#城市大脑" class="headerlink" title="城市大脑"></a>城市大脑</h1><p>给定一张图，每条边的边权初始化为 $1$ ，一共有 $k$ 次操作，每次操作可以将一条边的边权加一，最后通过一条边的时间为 $\frac{1}w$，最小化从 $s1$ 到 $t1$ 和从 $s2$ 到 $t2$ 的时间总和 。</p>
<p>首先注意到路径可以被分为两种，一种是两人都走的一种是只有一个走的，不难发现两人都走的一定是一段连续的路程，不然让一个人改走另一段一定更优，所以可以直接枚举连续的一段然后计算时间，枚举是 $N^2$ 的，考虑如何计算时间，随着分配给两人都走的路径的时间的增加，代价一定是先减后增，猜测函数单峰，事实上确实是，所以直接三分即可，不过由于路径一共是 $N^2$ 的，每次三分太慢，考虑优化，实际上对于连续路程一样的只需要跑非连续路程最短的即可，优化后三分的次数是线性的，可以直接做。</p>
<h1 id="按钮"><a href="#按钮" class="headerlink" title="按钮"></a>按钮</h1><blockquote>
<p>有一块可以显示 $5$ 位数字的显示屏，每次系统从 $[L,R]$ 中选出一个数字，一次操作可以是改变显示屏上的一个数和询问数字与这个数的大小关系，问最少多少次可以知道显示屏上边是多少。</p>
</blockquote>
<p>有一个显然的暴力是 $dp[x][l][r]$ 表示当前显示屏的数字是 $x$，区间为 $[l,r]$ 时的最小花费。</p>
<p>这样做比较慢，注意到答案不会太大，如果忽略操作次数大概是 $log$ 的，由于改变数字有常数所以实际上会略微大一点，不过不会超过 $42$ ，而且状态中 $x$ 要么等于 $l-1$ 要么等于 $r+1$ ，所以可以定义 $dpl[x][i]$ 表示显示屏数字为 $x$ ，操作 $i$ 次，得到的最小左端点，定义 $dpr[x][i]$ 同上，现在考虑转移，$dpl[x][i]$ 可以对 $dpl[m][i-1-dis]$ 取 $\min$ 当且仅当 $dpr[m][i-1-dis]\ge x-1$，为了保证能够完全覆盖区间，所以要有右端点的限制，如果没有 $dis$ 那么可以直接二维数点，但是有 $dis$ 的限制就不太好做，可以考虑枚举 $dis$ 然后把一些位置变成通配符去匹配，这样就能够做二维数点了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> pos,val;<br>&#125;;<br><span class="hljs-type">int</span> dpl[<span class="hljs-number">46</span>][N],dpr[<span class="hljs-number">46</span>][N];<br>vector&lt;Node&gt; vec[N];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">chk</span><span class="hljs-params">(rint x,rint y)</span></span>&#123;<br>	rint res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">6</span>;i++)&#123;<br>		<span class="hljs-keyword">if</span>(x%<span class="hljs-number">10</span>!=y%<span class="hljs-number">10</span>)res++;<br>		x/=<span class="hljs-number">10</span>;y/=<span class="hljs-number">10</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-type">int</span> cnt[<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>],val[N&lt;&lt;<span class="hljs-number">1</span>],w[N][<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;<span class="hljs-number">32</span>;i++)<br>		cnt[i]=cnt[i&gt;&gt;<span class="hljs-number">1</span>]+(i&amp;<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">memset</span>(dpl,<span class="hljs-number">0x3f</span>,<span class="hljs-built_in">sizeof</span>(dpl));<br>	rint n=<span class="hljs-number">1e5</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		dpl[<span class="hljs-number">0</span>][i]=i<span class="hljs-number">-1</span>,dpr[<span class="hljs-number">0</span>][i]=i+<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">32</span>;j++)&#123;<br>			rint wv=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span>(rint x=i,k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">5</span>;k++,x/=<span class="hljs-number">10</span>)&#123;<br>				<span class="hljs-keyword">if</span>(j&gt;&gt;k&amp;<span class="hljs-number">1</span>)wv=wv*<span class="hljs-number">11</span>+<span class="hljs-number">10</span>;<br>				<span class="hljs-keyword">else</span> wv=wv*<span class="hljs-number">11</span>+x%<span class="hljs-number">10</span>;<br>			&#125;<br>			w[i][j]=wv;<br>		&#125;<br>	&#125;<br>	dpl[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;dpr[<span class="hljs-number">0</span>][n]=n;<br>	<span class="hljs-keyword">for</span>(rint c=<span class="hljs-number">1</span>;c&lt;=<span class="hljs-number">45</span>;c++)&#123;<br>		<span class="hljs-built_in">memset</span>(val,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(val));<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>			vec[i].<span class="hljs-built_in">clear</span>();<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">32</span>;j++)&#123;<br>				<span class="hljs-keyword">if</span>(cnt[j]&gt;=c)<span class="hljs-keyword">continue</span>;<br>				vec[dpl[c-cnt[j]<span class="hljs-number">-1</span>][i]].<span class="hljs-built_in">push_back</span>((Node)&#123;w[i][j],dpr[c-cnt[j]<span class="hljs-number">-1</span>][i]&#125;);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(Node v:vec[<span class="hljs-number">1</span>])<br>			val[v.pos]=<span class="hljs-built_in">max</span>(val[v.pos],v.val);<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>			<span class="hljs-keyword">for</span>(Node v:vec[i+<span class="hljs-number">1</span>])<br>				val[v.pos]=<span class="hljs-built_in">max</span>(val[v.pos],v.val);<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">32</span>;j++)&#123;<br>				dpr[c][i]=<span class="hljs-built_in">max</span>(dpr[c][i],val[w[i][j]]);<br>			&#125;<br>		&#125;<br>		<span class="hljs-built_in">memset</span>(val,<span class="hljs-number">0x3f</span>,<span class="hljs-built_in">sizeof</span>(val));<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>			vec[i].<span class="hljs-built_in">clear</span>();<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">32</span>;j++)&#123;<br>				<span class="hljs-keyword">if</span>(cnt[j]&gt;=c)<span class="hljs-keyword">continue</span>;<br>				vec[dpr[c-cnt[j]<span class="hljs-number">-1</span>][i]].<span class="hljs-built_in">push_back</span>((Node)&#123;w[i][j],dpl[c-cnt[j]<span class="hljs-number">-1</span>][i]&#125;);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(Node v:vec[n])<br>			val[v.pos]=<span class="hljs-built_in">min</span>(val[v.pos],v.val);<br>		<span class="hljs-keyword">for</span>(rint i=n;i;i--)&#123;<br>			<span class="hljs-keyword">for</span>(Node v:vec[i<span class="hljs-number">-1</span>])<br>				val[v.pos]=<span class="hljs-built_in">min</span>(val[v.pos],v.val);<br>			<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">32</span>;j++)&#123;<br>				dpl[c][i]=<span class="hljs-built_in">min</span>(dpl[c][i],val[w[i][j]]);<br>			&#125;<br>		&#125;<br>	&#125;<br>	rint T;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;T);<br>	<span class="hljs-keyword">while</span>(T--)&#123;<br>		rint L,R;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;L,&amp;R);<br>		rint res=<span class="hljs-number">1e9</span>;<br>		<span class="hljs-keyword">for</span>(rint i=L;i&lt;=R;i++)&#123;<br>			rint r1=<span class="hljs-number">0</span>,r2=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">while</span>(dpl[r1][i]&gt;L)r1++;<br>			<span class="hljs-keyword">while</span>(dpr[r2][i]&lt;R)r2++;<br>			res=<span class="hljs-built_in">min</span>(res,<span class="hljs-built_in">chk</span>(<span class="hljs-number">0</span>,i)+<span class="hljs-built_in">max</span>(r1,r2)+<span class="hljs-number">1</span>);<br>		&#125;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,res);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="蛋糕"><a href="#蛋糕" class="headerlink" title="蛋糕"></a>蛋糕</h1><blockquote>
<p>有 $n$ 个点，每个点有三个值域区间，找出三个整数满足所有的点至少有一个区间包含了给定点。</p>
</blockquote>
<p>实际上不太好做，但是发现可以枚举两个点，然后判断剩下的那一维有没有解，剩下的那一维是对一个数取 $\max,\min$ ，这样做是 $n^3$ 的，考虑对于第一维进行线段树分治，对于第二维开一棵线段树，每个叶子节点表示当 第二维取这个节点时，第三维的区间范围，发现这个线段树不太好维护，所以尝试直接在叶子节点下推所有标记，然后看起来时间复杂度比较高，不过由于有一些减枝所以可以通过。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&#123;<br>	<span class="hljs-type">int</span> mx[<span class="hljs-number">3</span>],mn[<span class="hljs-number">3</span>];<br>&#125;a[N];<br><span class="hljs-type">int</span> q[N],tt,Max[<span class="hljs-number">3</span>],rk[<span class="hljs-number">3</span>][N];<br>vector&lt;Node&gt; vec[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(rint x,rint l,rint r,rint cl,rint cr,Node v)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(cl&lt;=l&amp;&amp;r&lt;=cr)&#123;<br>		vec[x].<span class="hljs-built_in">push_back</span>(v);<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=mid)<span class="hljs-built_in">insert</span>(x&lt;&lt;<span class="hljs-number">1</span>,l,mid,cl,cr,v);<br>	<span class="hljs-keyword">if</span>(cr&gt;mid)<span class="hljs-built_in">insert</span>(x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r,cl,cr,v);<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Bin</span>&#123;<br>	<span class="hljs-type">int</span> pos,tag1,tag2;<br>&#125;stk[N*<span class="hljs-number">32</span>];<br><span class="hljs-type">int</span> tp,tag1[N&lt;&lt;<span class="hljs-number">2</span>],tag2[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(rint x,rint l,rint r,rint cl,rint cr,rint v1,rint v2)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(cl&lt;=l&amp;&amp;r&lt;=cr)&#123;<br>		stk[++tp]=(Bin)&#123;x,tag1[x],tag2[x]&#125;;<br>		tag1[x]=<span class="hljs-built_in">max</span>(tag1[x],v1);<br>		tag2[x]=<span class="hljs-built_in">min</span>(tag2[x],v2);<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=mid)<span class="hljs-built_in">update</span>(x&lt;&lt;<span class="hljs-number">1</span>,l,mid,cl,cr,v1,v2);<br>	<span class="hljs-keyword">if</span>(cr&gt;mid)<span class="hljs-built_in">update</span>(x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r,cl,cr,v1,v2);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(rint x,rint l,rint r,rint cl,rint cr,rint res)</span></span>&#123;<br>	cl=<span class="hljs-built_in">max</span>(cl,tag1[x]);cr=<span class="hljs-built_in">min</span>(cr,tag2[x]);<br>	<span class="hljs-keyword">if</span>(cl&gt;cr)<span class="hljs-keyword">return</span> ;<br>	<span class="hljs-keyword">if</span>(l==r)&#123;<br>		<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Yes&quot;</span>);<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d %d %d\n&quot;</span>,rk[<span class="hljs-number">0</span>][res],rk[<span class="hljs-number">1</span>][l],rk[<span class="hljs-number">2</span>][cl]);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">dfs2</span>(x&lt;&lt;<span class="hljs-number">1</span>,l,mid,cl,cr,res);<br>	<span class="hljs-built_in">dfs2</span>(x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r,cl,cr,res);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint x,rint l,rint r)</span></span>&#123;<br>	rint now=tp;<br>	<span class="hljs-keyword">for</span>(Node v:vec[x])&#123;<br>		<span class="hljs-keyword">if</span>(v.mn[<span class="hljs-number">1</span>]!=<span class="hljs-number">1</span>)<span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,Max[<span class="hljs-number">1</span>],<span class="hljs-number">1</span>,v.mn[<span class="hljs-number">1</span>]<span class="hljs-number">-1</span>,v.mn[<span class="hljs-number">2</span>],v.mx[<span class="hljs-number">2</span>]);<br>		<span class="hljs-keyword">if</span>(v.mx[<span class="hljs-number">1</span>]!=Max[<span class="hljs-number">1</span>])<span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,Max[<span class="hljs-number">1</span>],v.mx[<span class="hljs-number">1</span>]+<span class="hljs-number">1</span>,Max[<span class="hljs-number">1</span>],v.mn[<span class="hljs-number">2</span>],v.mx[<span class="hljs-number">2</span>]);<br>	&#125;<br>	<span class="hljs-keyword">if</span>(l==r)&#123;<br>		<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,Max[<span class="hljs-number">1</span>],<span class="hljs-number">1</span>,Max[<span class="hljs-number">2</span>],l);<br>	&#125;<span class="hljs-keyword">else</span> &#123;<br>		rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">dfs</span>(x&lt;&lt;<span class="hljs-number">1</span>,l,mid);<br>		<span class="hljs-built_in">dfs</span>(x&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid+<span class="hljs-number">1</span>,r);<br>	&#125;<br>	<span class="hljs-keyword">while</span>(tp!=now)&#123;<br>		Bin u=stk[tp--];<br>		tag1[u.pos]=u.tag1;<br>		tag2[u.pos]=u.tag2;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">memset</span>(tag2,<span class="hljs-number">0x3f</span>,<span class="hljs-built_in">sizeof</span>(tag2));<br>	rint n;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">3</span>;j++)<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;a[i].mn[j],&amp;a[i].mx[j]);<br>	<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">3</span>;j++)&#123;<br>		tt=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>			q[++tt]=a[i].mn[j],q[++tt]=a[i].mx[j];<br>		<span class="hljs-built_in">sort</span>(q+<span class="hljs-number">1</span>,q+tt+<span class="hljs-number">1</span>);<br>		tt=<span class="hljs-built_in">unique</span>(q+<span class="hljs-number">1</span>,q+tt+<span class="hljs-number">1</span>)-q<span class="hljs-number">-1</span>;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tt;i++)<br>			rk[j][i]=q[i];<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>			a[i].mn[j]=<span class="hljs-built_in">lower_bound</span>(q+<span class="hljs-number">1</span>,q+tt+<span class="hljs-number">1</span>,a[i].mn[j])-q;<br>			a[i].mx[j]=<span class="hljs-built_in">lower_bound</span>(q+<span class="hljs-number">1</span>,q+tt+<span class="hljs-number">1</span>,a[i].mx[j])-q;<br>		&#125;<br>		Max[j]=tt;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		<span class="hljs-keyword">if</span>(a[i].mn[<span class="hljs-number">0</span>]!=<span class="hljs-number">1</span>)<span class="hljs-built_in">insert</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,Max[<span class="hljs-number">0</span>],<span class="hljs-number">1</span>,a[i].mn[<span class="hljs-number">0</span>]<span class="hljs-number">-1</span>,a[i]);<br>		<span class="hljs-keyword">if</span>(a[i].mx[<span class="hljs-number">0</span>]!=Max[<span class="hljs-number">0</span>])<span class="hljs-built_in">insert</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,Max[<span class="hljs-number">0</span>],a[i].mx[<span class="hljs-number">0</span>]+<span class="hljs-number">1</span>,Max[<span class="hljs-number">0</span>],a[i]);<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,Max[<span class="hljs-number">0</span>]);<br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;NO&quot;</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="猜猜"><a href="#猜猜" class="headerlink" title="猜猜"></a>猜猜</h1><blockquote>
<p>有 $n$ 个宝石，每个宝石有颜色和价值，支持两种操作，将某种宝石的颜色或者价值替换，从某个位置开始取宝石，最多有 $k$ 个不取，每种颜色最多取 $k$ 种。</p>
</blockquote>
<p>$k\leq10$ 。</p>
<p>首先考虑确定了取到的右端点 $r$，那么怎么决策取哪个，首先需要决策的最多只有 $k$ 个，其余的都只有一种，所以对于出现一次的求和，对于其它的取最大值。</p>
<p>现在的问题是怎么求 $r$ 和找出不超过 $k$ 个需要决策的数，不难发现这两个可以同时进行，现在的问题是怎么找出 $k$ 个需要决策的数，令 $pre_i$ 表示 $i$ 的前一个和这个数颜色一样的数的位置，那么当且仅当 $pre_i&gt;=l$ 的时候才有贡献，这样的数可以用线段树找到。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">int</span> pre[N],col[N],val[N];<br>set&lt;<span class="hljs-type">int</span>&gt; pos[N];<br>set&lt;<span class="hljs-type">int</span>&gt;::iterator it;<br><span class="hljs-type">int</span> Max[N&lt;&lt;<span class="hljs-number">2</span>];<br>ll sum[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ls rt&lt;&lt;1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rs rt&lt;&lt;1|1</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">up</span><span class="hljs-params">(rint rt)</span></span>&#123;<br>	sum[rt]=sum[ls]+sum[rs];<br>	Max[rt]=<span class="hljs-built_in">max</span>(Max[ls],Max[rs]);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(rint rt,rint l,rint r,rint pos,rint v1,rint v2)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)&#123;<br>		Max[rt]=v1;<br>		sum[rt]=v2;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(pos&lt;=mid)<span class="hljs-built_in">update</span>(ls,l,mid,pos,v1,v2);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">update</span>(rs,mid+<span class="hljs-number">1</span>,r,pos,v1,v2);<br>	<span class="hljs-built_in">up</span>(rt);<br>&#125;<br><span class="hljs-type">int</span> q[N],w[N],tt,k,s;<br><span class="hljs-function">ll <span class="hljs-title">query</span><span class="hljs-params">(rint rt,rint l,rint r,rint cl,rint cr)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(tt&gt;k)<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=l&amp;&amp;r&lt;=cr&amp;&amp;Max[rt]&lt;s)<span class="hljs-keyword">return</span> sum[rt];<br>	<span class="hljs-keyword">if</span>(l==r)&#123;<br>		<span class="hljs-keyword">if</span>(Max[rt]&gt;=s)&#123;<br>			q[++tt]=l;<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> sum[rt];<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(cr&lt;=mid)<span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(ls,l,mid,cl,cr);<br>	<span class="hljs-keyword">if</span>(cl&gt;mid)<span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(rs,mid+<span class="hljs-number">1</span>,r,cl,cr);<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(ls,l,mid,cl,cr)+<span class="hljs-built_in">query</span>(rs,mid+<span class="hljs-number">1</span>,r,cl,cr);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n,m;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;col[i],&amp;val[i]);<br>		<span class="hljs-keyword">if</span>(!pos[col[i]].<span class="hljs-built_in">empty</span>())pre[i]=*pos[col[i]].<span class="hljs-built_in">rbegin</span>();<br>		<span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,i,pre[i],val[i]);<br>		pos[col[i]].<span class="hljs-built_in">insert</span>(i);<br>	&#125;<br>	<span class="hljs-keyword">while</span>(m--)&#123;<br>		rint opt;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;opt);<br>		<span class="hljs-keyword">if</span>(opt==<span class="hljs-number">1</span>)&#123;<br>			rint v1,v2,v3;<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;v1,&amp;v2,&amp;v3);<br>			it=pos[col[v1]].<span class="hljs-built_in">upper_bound</span>(v1);<br>			<span class="hljs-keyword">if</span>(it!=pos[col[v1]].<span class="hljs-built_in">end</span>())&#123;<br>				rint p=*it;<br>				<span class="hljs-keyword">if</span>(--it!=pos[col[v1]].<span class="hljs-built_in">begin</span>())pre[p]=*--it;<br>				<span class="hljs-keyword">else</span> pre[p]=<span class="hljs-number">0</span>;<br>				<span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,p,pre[p],val[p]);<br>			&#125;<br>			pos[col[v1]].<span class="hljs-built_in">erase</span>(v1);<br>			col[v1]=v2;val[v1]=v3;<br>			pos[col[v1]].<span class="hljs-built_in">insert</span>(v1);<br>			it=pos[col[v1]].<span class="hljs-built_in">upper_bound</span>(v1);<br>			<span class="hljs-keyword">if</span>(it!=pos[col[v1]].<span class="hljs-built_in">end</span>())&#123;<br>				rint p=*it;<br>				pre[p]=v1;<br>				<span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,p,pre[p],val[p]);<br>			&#125;<br>			it=pos[col[v1]].<span class="hljs-built_in">find</span>(v1);<br>			<span class="hljs-keyword">if</span>(it!=pos[col[v1]].<span class="hljs-built_in">begin</span>())pre[v1]=*--it;<br>			<span class="hljs-keyword">else</span> pre[v1]=<span class="hljs-number">0</span>;<br>			<span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,v1,pre[v1],val[v1]);<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;s,&amp;k);tt=<span class="hljs-number">0</span>;<br>			rll res=<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,s,n);<br>			<span class="hljs-keyword">if</span>(tt&gt;k)tt--;<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tt;i++)&#123;<br>				rint nxt=pre[q[i]];<br>				<span class="hljs-keyword">if</span>(pre[nxt]&lt;s)&#123;<br>					res-=val[nxt];<br>					w[col[nxt]]=<span class="hljs-built_in">max</span>(w[col[nxt]],val[nxt]);<br>				&#125;<br>				w[col[nxt]]=<span class="hljs-built_in">max</span>(w[col[nxt]],val[q[i]]);<br>			&#125;<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tt;i++)<br>				res+=w[col[q[i]]],w[col[q[i]]]=<span class="hljs-number">0</span>;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="今天"><a href="#今天" class="headerlink" title="今天"></a>今天</h1><blockquote>
<p>给出放置每个字符的概率，每次随机放置字符，当这个字符包含给出的某个子串时就停止，求停止的期望，需要对于某个字符串的所有前缀回答。</p>
</blockquote>
<p>如果是一个串的匹配可以直接用 $kmp$ ，对于多个串的话考虑 $AC$ 自动机，暴力列出转移的式子然后高斯消元不太行，不过可以用 $n$ 个特殊量来表示所有的变量，这样的话只需要对于最后的 $n$ 个点跑高斯消元即可，问题在于怎么找 $n$ 个点，事实上可以直接对 Trie 树跑随机链剖分，这样将每个链的链顶自己表示自己即可，转移的时候从父亲转移过来。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e4</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">char</span> s[N];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-type">int</span> f[<span class="hljs-number">110</span>],g[N],mt[<span class="hljs-number">110</span>][<span class="hljs-number">110</span>],b[<span class="hljs-number">110</span>],a[N][<span class="hljs-number">110</span>],ans[N];<br><span class="hljs-type">int</span> n,m,k,ch[N][<span class="hljs-number">26</span>],cnt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">()</span></span>&#123;<br>	rint now=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=m;i++)&#123;<br>		rint x=s[i]-<span class="hljs-string">&#x27;a&#x27;</span>;<br>		<span class="hljs-keyword">if</span>(!ch[now][x])ch[now][x]=++cnt;<br>		now=ch[now][x];<br>	&#125;<br>&#125;<br><span class="hljs-type">int</span> fail[N],q[N],id[N],tot,hh,tt,tot2;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">bfs</span><span class="hljs-params">()</span></span>&#123;<br>	hh=<span class="hljs-number">0</span>;tt=<span class="hljs-number">-1</span>;q[++tt]=<span class="hljs-number">0</span>;id[<span class="hljs-number">0</span>]=++tot;a[<span class="hljs-number">0</span>][tot]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">while</span>(hh&lt;=tt)&#123;<br>		rint u=q[hh++],son=<span class="hljs-number">0</span>,gl=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;k;i++)&#123;<br>			<span class="hljs-keyword">if</span>(ch[u][i])&#123;<br>				<span class="hljs-keyword">if</span>(u)fail[ch[u][i]]=ch[fail[u]][i];<br>				q[++tt]=ch[u][i];<br>				<span class="hljs-keyword">if</span>(son)id[ch[u][i]]=++tot,a[ch[u][i]][tot]=<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">else</span> son=ch[u][i],gl=<span class="hljs-built_in">fpow</span>(g[i],p<span class="hljs-number">-2</span>);<br>			&#125;<span class="hljs-keyword">else</span> ch[u][i]=ch[fail[u]][i];<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!son)&#123;<br>			b[++tot2]=(p-a[u][<span class="hljs-number">0</span>])%p;<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot;i++)<br>				mt[tot2][i]=a[u][i];<br>		&#125;<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=tot;i++)<br>				a[son][i]=<span class="hljs-number">1ll</span>*a[u][i]*gl%p;<br>			a[son][<span class="hljs-number">0</span>]=(a[son][<span class="hljs-number">0</span>]+p-gl)%p;<br>			<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;k;i++)&#123;<br>				<span class="hljs-keyword">if</span>(ch[u][i]==son)<span class="hljs-keyword">continue</span>;<br>				<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;=tot;j++)<br>					a[son][j]=(a[son][j]+p<span class="hljs-number">-1ll</span>*a[ch[u][i]][j]*gl%p*g[i]%p)%p;<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;n,&amp;m,&amp;k);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;k;i++)&#123;<br>		rint x;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x);<br>		g[i]=x*<span class="hljs-built_in">fpow</span>(<span class="hljs-number">100</span>,p<span class="hljs-number">-2</span>)%p;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s+<span class="hljs-number">1</span>);<br>		<span class="hljs-built_in">insert</span>();<br>	&#125;<br>	<span class="hljs-built_in">bfs</span>();<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot;i++)&#123;<br>		<span class="hljs-keyword">if</span>(!mt[i][i])&#123;<br>			<span class="hljs-keyword">for</span>(rint j=i;j&lt;=tot;j++)&#123;<br>				<span class="hljs-keyword">if</span>(mt[j][i])&#123;<br>					<span class="hljs-keyword">for</span>(rint z=<span class="hljs-number">1</span>;z&lt;=tot;z++)<br>						<span class="hljs-built_in">swap</span>(mt[i][z],mt[j][z]);<br>					<span class="hljs-built_in">swap</span>(b[i],b[j]);<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=tot;j++)&#123;<br>			<span class="hljs-keyword">if</span>(!mt[j][i]||i==j)<span class="hljs-keyword">continue</span>;<br>			ll r=<span class="hljs-number">1ll</span>*mt[j][i]*<span class="hljs-built_in">fpow</span>(mt[i][i],p<span class="hljs-number">-2</span>)%p;<br>			<span class="hljs-keyword">for</span>(rint z=i;z&lt;=tot;z++)<br>				mt[j][z]=(mt[j][z]-mt[i][z]*r%p+p)%p;<br>			b[j]=(b[j]-b[i]*r%p+p)%p;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=tot;i++)<br>		b[i]=b[i]*<span class="hljs-built_in">fpow</span>(mt[i][i],p<span class="hljs-number">-2</span>)%p;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;=cnt;i++)&#123;<br>		ans[i]=a[i][<span class="hljs-number">0</span>];<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">1</span>;j&lt;=tot;j++)<br>			ans[i]+=<span class="hljs-number">1ll</span>*a[i][j]*b[j]%p;<br>		ans[i]%=p;<br>	&#125;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s+<span class="hljs-number">1</span>);<br>	rint now=<span class="hljs-number">0</span>;m=<span class="hljs-built_in">strlen</span>(s+<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=m;i++)&#123;<br>		now=ch[now][s[i]-<span class="hljs-string">&#x27;a&#x27;</span>];<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,(ans[now]+i)%p);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="是谁"><a href="#是谁" class="headerlink" title="是谁"></a>是谁</h1><p>验证冰雹猜想。</p>
<p>由于冰雹猜想一个数的操作次数不会很多，所以直接模拟就行了。</p>
<p>考虑如何快速模拟这个过程，首先不难想到压位，有一个$O(ans\frac{n}w)$ 的做法，显然是过不去的，这个东西时间复杂度比较高的原因在于进位的次数比较多，考虑优化掉进位的次数，没有必要每一次操作都进位，实际上可以在处理完一块后统一进位，这样做的时间复杂度是 $O(ans+(\frac{n}w)^2)$ 的，可以通过。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e7</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> w=<span class="hljs-number">19</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> B=<span class="hljs-number">1</span>&lt;&lt;w;<br><span class="hljs-type">char</span> s[N];<br>ll a[N],k2[B],b2[B],r[B];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">(rll x)</span></span>&#123;<br>	rll t=x,k=<span class="hljs-number">1</span>,b=<span class="hljs-number">0</span>,res=<span class="hljs-number">0</span>,bas=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">while</span>(bas&lt;B)&#123;<br>		<span class="hljs-keyword">if</span>(x%(bas&lt;&lt;<span class="hljs-number">1</span>)==<span class="hljs-number">0</span>)bas&lt;&lt;=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">else</span> x=x*<span class="hljs-number">3</span>+bas,k=k*<span class="hljs-number">3</span>,b=b*<span class="hljs-number">3</span>+bas;<br>		res++;<br>	&#125;<br>	k2[t]=k;b2[t]=b;r[t]=res;<br>	<span class="hljs-keyword">return</span> ;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> ll <span class="hljs-title">solve2</span><span class="hljs-params">(rll x)</span></span>&#123;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(x!=<span class="hljs-number">1</span>)&#123;<br>		<span class="hljs-keyword">if</span>(x&amp;<span class="hljs-number">1</span>)x=x*<span class="hljs-number">3</span>+<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">else</span> x&gt;&gt;=<span class="hljs-number">1</span>;<br>		res++;<br>	&#125;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s+<span class="hljs-number">1</span>);<br>	rint n=<span class="hljs-built_in">strlen</span>(s+<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">reverse</span>(s+<span class="hljs-number">1</span>,s+n+<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i+=w)<br>		<span class="hljs-keyword">for</span>(rint j=<span class="hljs-number">0</span>;j&lt;w&amp;&amp;i+j&lt;=n;j++)<br>			a[i/w+<span class="hljs-number">1</span>]|=(s[i+j]-<span class="hljs-string">&#x27;0&#x27;</span>)&lt;&lt;j;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">0</span>;i&lt;B;i++)<br>		<span class="hljs-built_in">solve</span>(i);<br>	n=(n<span class="hljs-number">-1</span>)/w+<span class="hljs-number">1</span>;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)&#123;<br>		<span class="hljs-keyword">if</span>(i==n)res+=<span class="hljs-built_in">solve2</span>(a[i]);<br>		<span class="hljs-keyword">else</span> &#123;<br>			res+=r[a[i]];<br>			rll t=a[i];<br>			<span class="hljs-keyword">for</span>(rint j=i;j&lt;=n;j++)<br>				a[j]*=k2[t];<br>			a[i]+=b2[t];t=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span>(rint j=i;j&lt;=n;j++)<br>				a[j]+=t,t=a[j]&gt;&gt;w,a[j]&amp;=B<span class="hljs-number">-1</span>;<br>			<span class="hljs-keyword">if</span>(t)n++,a[n]=t;<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="简单题"><a href="#简单题" class="headerlink" title="简单题"></a>简单题</h1><blockquote>
<p>维护一个数组 $a$ ，给定 $[l,r]$ 和 $v$，对于区间内的每个 $a_i$ ，支持两种操作</p>
<ul>
<li> $a_i=v$</li>
<li> $b[a_i]+=v$</li>
</ul>
</blockquote>
<p>发现可以简单分块维护，如果一个块有赋值标记那么直接加到标记上，否则新开一个。</p>
<p>进一步发现如果只维护这两个操作那么实际上没有必要用分块，线段树就行了，标记的处理同理，注意如果一个节点同时有赋值和加法，那么加法一定是给下面的节点，因为上面传来的加法都加在了赋值上。</p>
<p>上述做法是数据结构写傻了的类型，考虑时光倒流，那么每次赋值操作相当于取走一段区间的数然后加上来，所以只需要写区间加和区间清空。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">5e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>&#123;<br>	rint x=<span class="hljs-number">0</span>,f=<span class="hljs-number">1</span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-string">&#x27;0&#x27;</span>||ch&gt;<span class="hljs-string">&#x27;9&#x27;</span>)&#123;<span class="hljs-keyword">if</span>(ch==<span class="hljs-string">&#x27;-&#x27;</span>)f=<span class="hljs-number">-1</span>;ch=<span class="hljs-built_in">getchar</span>();&#125;<br>	<span class="hljs-keyword">while</span>(ch&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;ch&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)&#123;x=x*<span class="hljs-number">10</span>+ch-<span class="hljs-string">&#x27;0&#x27;</span>;ch=<span class="hljs-built_in">getchar</span>();&#125;<br>	<span class="hljs-keyword">return</span> x*f;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ls rt&lt;&lt;1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rs rt&lt;&lt;1|1</span><br><span class="hljs-type">int</span> tag[N&lt;&lt;<span class="hljs-number">2</span>];<br>ll tag2[N&lt;&lt;<span class="hljs-number">2</span>],b[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Build</span><span class="hljs-params">(rint rt,rint l,rint r)</span></span>&#123;<br>	tag[rt]=<span class="hljs-number">-1</span>;<br>	<span class="hljs-keyword">if</span>(l==r)&#123;<br>		tag[rt]=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">Build</span>(ls,l,mid);<br>	<span class="hljs-built_in">Build</span>(rs,mid+<span class="hljs-number">1</span>,r);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">down</span><span class="hljs-params">(rint rt,rint l,rint r)</span></span>&#123;<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(tag2[rt])&#123;<br>		<span class="hljs-keyword">if</span>(tag[ls]!=<span class="hljs-number">-1</span>)b[tag[ls]]+=tag2[rt]*(mid-l+<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">else</span> tag2[ls]+=tag2[rt];<br>		<span class="hljs-keyword">if</span>(tag[rs]!=<span class="hljs-number">-1</span>)b[tag[rs]]+=tag2[rt]*(r-mid);<br>		<span class="hljs-keyword">else</span> tag2[rs]+=tag2[rt];<br>		tag2[rt]=<span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(tag[rt]!=<span class="hljs-number">-1</span>)&#123;<br>		tag[ls]=tag[rs]=tag[rt];<br>		tag[rt]=<span class="hljs-number">-1</span>;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(rint rt,rint l,rint r,rint cl,rint cr,rint v)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(cl&lt;=l&amp;&amp;r&lt;=cr)&#123;<br>		tag[rt]=v;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-built_in">down</span>(rt,l,r);<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=mid)<span class="hljs-built_in">modify</span>(ls,l,mid,cl,cr,v);<br>	<span class="hljs-keyword">if</span>(cr&gt;mid)<span class="hljs-built_in">modify</span>(rs,mid+<span class="hljs-number">1</span>,r,cl,cr,v);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(rint rt,rint l,rint r,rint cl,rint cr,rll v)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(cl&lt;=l&amp;&amp;r&lt;=cr)&#123;<br>		<span class="hljs-keyword">if</span>(tag[rt]!=<span class="hljs-number">-1</span>)b[tag[rt]]+=v*(r-l+<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">else</span> tag2[rt]+=v;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-built_in">down</span>(rt,l,r);<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(cl&lt;=mid)<span class="hljs-built_in">update</span>(ls,l,mid,cl,cr,v);<br>	<span class="hljs-keyword">if</span>(cr&gt;mid)<span class="hljs-built_in">update</span>(rs,mid+<span class="hljs-number">1</span>,r,cl,cr,v);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint rt,rint l,rint r)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)<span class="hljs-keyword">return</span> ;<br>	<span class="hljs-built_in">down</span>(rt,l,r);<br>	rint mid=l+r&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">dfs</span>(ls,l,mid);<span class="hljs-built_in">dfs</span>(rs,mid+<span class="hljs-number">1</span>,r);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n=<span class="hljs-built_in">read</span>(),m=<span class="hljs-built_in">read</span>(),q=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">Build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	<span class="hljs-keyword">while</span>(q--)&#123;<br>		rint opt=<span class="hljs-built_in">read</span>(),l=<span class="hljs-built_in">read</span>(),r=<span class="hljs-built_in">read</span>(),v=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-keyword">if</span>(opt==<span class="hljs-number">1</span>)<br>			<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,v);<br>		<span class="hljs-keyword">else</span> <br>			<span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,v);<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,b[i]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="树上游走"><a href="#树上游走" class="headerlink" title="树上游走"></a>树上游走</h1><blockquote>
<p>在树上从 $S$ 开始随机游走，每次等概率向外走一条边，一个点走出去两次之后就消失了，问最后停在每个点的概率。</p>
</blockquote>
<p>首先分析一下一次游走的性质，显然最后只会停在度数为二的节点或者度数为一的 $S$ 节点或者叶子节点，所以只在度数不超过二的时候停机答案，假如以 $S$ 为根做 $dfs$ ，那么走到一个点时，如果它作为最后一个点，那么它的父亲必须要在走下来时消失，不然再次走上去这个点的子树走不完，而如果不作为最后的点，它的父亲是可以存在的，而父亲的存在与否是会影响到下一步的概率，所以需要维护一个 $dp[u][0/1]$ 表示走到 $u$，它的父亲在不在的概率，然后进一步发现，父亲消失了就需要走儿子，因为儿子必须消失所以至少要走两步，走一步的时候这个儿子是存在的，这个也是会影响下一步的概率的，所以维护一个 $sp$ 数组，表示这个点向下走一步的概率，这个是非常好维护的，还有一个 $f$ 数组，表示向下走至少两步的概率，维护出来之后随便转移一下即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span>+<span class="hljs-number">10</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> p=<span class="hljs-number">998244353</span>;<br><span class="hljs-function">ll <span class="hljs-title">fpow</span><span class="hljs-params">(rll a,rll b)</span></span>&#123;<br>	rll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>,a=a*a%p)<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>)res=res*a%p;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;<br>	e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>&#125;<br><span class="hljs-type">int</span> n,s,w[N],du[N];<br>ll d1[N],d2[N];<br>ll f[N][<span class="hljs-number">2</span>],g[N],dp[N][<span class="hljs-number">2</span>],sp[N][<span class="hljs-number">2</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint u,rint fa)</span></span>&#123;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa)<span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">dfs</span>(v,u);<br>		sp[u][<span class="hljs-number">0</span>]=(sp[u][<span class="hljs-number">0</span>]+d2[u]*d1[v])%p;<br>		f[u][<span class="hljs-number">0</span>]=(f[u][<span class="hljs-number">0</span>]+f[v][<span class="hljs-number">1</span>]*d2[u]%p*d2[v]+sp[v][<span class="hljs-number">1</span>]*d2[u]%p*d1[v])%p;<br>		sp[u][<span class="hljs-number">1</span>]=(sp[u][<span class="hljs-number">1</span>]+d1[u]*d1[v])%p;<br>		f[u][<span class="hljs-number">1</span>]=(f[u][<span class="hljs-number">1</span>]+f[v][<span class="hljs-number">1</span>]*d1[u]%p*d2[v]+sp[v][<span class="hljs-number">1</span>]*d1[u]%p*d1[v])%p;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(rint u,rint fa,rll lstp)</span></span>&#123;<br>	<span class="hljs-keyword">if</span>(du[u]==<span class="hljs-number">2</span>)<br>		g[u]=dp[u][<span class="hljs-number">0</span>]*f[u][<span class="hljs-number">0</span>]%p;<br>	<span class="hljs-keyword">if</span>(du[u]==<span class="hljs-number">1</span>)&#123;<br>		g[u]=(dp[u][<span class="hljs-number">0</span>]+lstp)%p;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(v==fa)<span class="hljs-keyword">continue</span>;<br>		sp[u][<span class="hljs-number">0</span>]-=d2[u]*d1[v]%p;sp[u][<span class="hljs-number">0</span>]=(sp[u][<span class="hljs-number">0</span>]+p)%p;<br>		sp[u][<span class="hljs-number">1</span>]-=d1[u]*d1[v]%p;sp[u][<span class="hljs-number">1</span>]=(sp[u][<span class="hljs-number">1</span>]+p)%p;<br>		f[u][<span class="hljs-number">0</span>]-=f[v][<span class="hljs-number">1</span>]*d2[u]%p*d2[v]%p+sp[v][<span class="hljs-number">1</span>]*d2[u]%p*d1[v]%p;f[u][<span class="hljs-number">0</span>]=(f[u][<span class="hljs-number">0</span>]%p+p)%p;<br>		f[u][<span class="hljs-number">1</span>]-=f[v][<span class="hljs-number">1</span>]*d1[u]%p*d2[v]%p+sp[v][<span class="hljs-number">1</span>]*d1[u]%p*d1[v]%p;f[u][<span class="hljs-number">1</span>]=(f[u][<span class="hljs-number">1</span>]%p+p)%p;<br>		dp[v][<span class="hljs-number">0</span>]=(dp[u][<span class="hljs-number">0</span>]*f[u][<span class="hljs-number">0</span>]%p*<span class="hljs-built_in">fpow</span>(du[u]<span class="hljs-number">-2</span>,p<span class="hljs-number">-2</span>)%p+dp[u][<span class="hljs-number">0</span>]*sp[u][<span class="hljs-number">0</span>]%p*d2[u]%p+<br>				lstp*d2[u]%p+dp[u][<span class="hljs-number">1</span>]*f[u][<span class="hljs-number">1</span>]%p*d2[u]%p+dp[u][<span class="hljs-number">1</span>]*sp[u][<span class="hljs-number">1</span>]%p*d1[u])%p;<br>		dp[v][<span class="hljs-number">1</span>]=(dp[u][<span class="hljs-number">0</span>]*d2[u]+dp[u][<span class="hljs-number">1</span>]*d1[u])%p;<br>		<span class="hljs-built_in">dfs2</span>(v,u,(dp[u][<span class="hljs-number">0</span>]*d2[u]%p*d1[v]%p*d2[u]%p+dp[u][<span class="hljs-number">1</span>]*d1[u]%p*d1[v]%p*d1[u]%p)%p);<br>		sp[u][<span class="hljs-number">0</span>]+=d2[u]*d1[v]%p;sp[u][<span class="hljs-number">0</span>]=(sp[u][<span class="hljs-number">0</span>]+p)%p;<br>		sp[u][<span class="hljs-number">1</span>]+=d1[u]*d1[v]%p;sp[u][<span class="hljs-number">1</span>]=(sp[u][<span class="hljs-number">1</span>]+p)%p;<br>		f[u][<span class="hljs-number">0</span>]+=f[v][<span class="hljs-number">1</span>]*d2[u]%p*d2[v]%p+sp[v][<span class="hljs-number">1</span>]*d2[u]%p*d1[v]%p;f[u][<span class="hljs-number">0</span>]=(f[u][<span class="hljs-number">0</span>]%p+p)%p;<br>		f[u][<span class="hljs-number">1</span>]+=f[v][<span class="hljs-number">1</span>]*d1[u]%p*d2[v]%p+sp[v][<span class="hljs-number">1</span>]*d1[u]%p*d1[v]%p;f[u][<span class="hljs-number">1</span>]=(f[u][<span class="hljs-number">1</span>]%p+p)%p;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">dfs</span>(s,<span class="hljs-number">0</span>);<br>	dp[s][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(rint i=h[s];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		sp[s][<span class="hljs-number">1</span>]-=d1[s]*d1[v]%p;sp[s][<span class="hljs-number">1</span>]=(sp[s][<span class="hljs-number">1</span>]+p)%p;<br>		f[s][<span class="hljs-number">1</span>]-=f[v][<span class="hljs-number">1</span>]*d1[s]%p*d2[v]%p+sp[v][<span class="hljs-number">1</span>]*d1[s]%p*d1[v]%p;f[s][<span class="hljs-number">1</span>]=(f[s][<span class="hljs-number">1</span>]%p+p)%p;<br>		dp[v][<span class="hljs-number">0</span>]=(dp[s][<span class="hljs-number">0</span>]*f[s][<span class="hljs-number">1</span>]%p*d2[s]%p+dp[s][<span class="hljs-number">0</span>]*sp[s][<span class="hljs-number">1</span>]%p*d1[s]%p)%p;<br>		dp[v][<span class="hljs-number">1</span>]=(dp[s][<span class="hljs-number">0</span>]*d1[s])%p;<br>		<span class="hljs-built_in">dfs2</span>(v,s,d1[v]*d1[s]%p*d1[s]%p);<br>		sp[s][<span class="hljs-number">1</span>]+=d1[s]*d1[v]%p;sp[s][<span class="hljs-number">1</span>]=(sp[s][<span class="hljs-number">1</span>]+p)%p;<br>		f[s][<span class="hljs-number">1</span>]+=f[v][<span class="hljs-number">1</span>]*d1[s]%p*d2[v]%p+sp[v][<span class="hljs-number">1</span>]*d1[s]%p*d1[v]%p;f[s][<span class="hljs-number">1</span>]=(f[s][<span class="hljs-number">1</span>]%p+p)%p;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(du[s]==<span class="hljs-number">1</span>)g[s]=f[s][<span class="hljs-number">1</span>];<br>	<span class="hljs-keyword">else</span> g[s]=<span class="hljs-number">0</span>;<br>	rll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		res+=g[i]*w[i]%p;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,res%p);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;s);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;w[i]);<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">2</span>;i&lt;=n;i++)&#123;<br>		rint x,y;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y);<br>		<span class="hljs-built_in">Ins</span>(x,y);<span class="hljs-built_in">Ins</span>(y,x);<br>		du[x]++;du[y]++;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		d2[i]=<span class="hljs-built_in">fpow</span>(du[i]<span class="hljs-number">-1</span>,p<span class="hljs-number">-2</span>),d1[i]=<span class="hljs-built_in">fpow</span>(du[i],p<span class="hljs-number">-2</span>);<br>	<span class="hljs-built_in">solve</span>();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="树的同构"><a href="#树的同构" class="headerlink" title="树的同构"></a>树的同构</h1><blockquote>
<p>给定一棵树，找到两个没有交的联通块使得存在一种重新标号的方式让这两个联通块形状一样。</p>
</blockquote>
<p>$n\leq50$</p>
<p>首先可以枚举一个联通子集然后用树哈希判断。</p>
<p>其次不难想到枚举两个点，钦定这两个点必选，然后剩下的事就是一步一步向外扩展，这个扩展是很不好做的，考虑定义一个数组 $F[x][y]$ 表示在同构中，$x$ 对应 $y$，这样得到的点集最大是多少，这样的话就转移是一个类似二分图最大带权匹配的东西，用费用流就行了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rint register int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rll register long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">55</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>	<span class="hljs-type">int</span> to,nxt;<br>&#125;e[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> h[N],idx,x[N],y[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b)</span></span>&#123;<br>	e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>&#125;<br><span class="hljs-keyword">namespace</span> Netflow&#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Edge</span>&#123;<br>		<span class="hljs-type">int</span> to,nxt,cost,val;<br>	&#125;e[N*N*<span class="hljs-number">2</span>];<br>	<span class="hljs-type">int</span> h[N],idx;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Ins</span><span class="hljs-params">(rint a,rint b,rint c,rint d)</span></span>&#123;<br>		e[++idx].to=b;e[idx].nxt=h[a];h[a]=idx;<br>		e[idx].val=c;e[idx].cost=d;<br>	&#125;<br>	<span class="hljs-type">int</span> mp[N],cnt,st,ed;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span>&#123;<br>		st=<span class="hljs-number">1</span>;ed=<span class="hljs-number">2</span>;cnt=<span class="hljs-number">2</span>;idx=<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">memset</span>(h,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(h));<br>	&#125;<br>	<span class="hljs-type">int</span> pre[N],dis[N];<br>	<span class="hljs-type">bool</span> vis[N];<br>	queue&lt;<span class="hljs-type">int</span>&gt; q;<br>	<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">spfa</span><span class="hljs-params">()</span></span>&#123;<br>		<span class="hljs-built_in">memset</span>(dis,<span class="hljs-number">-0x3f</span>,<span class="hljs-built_in">sizeof</span>(dis));<br>		q.<span class="hljs-built_in">push</span>(st);dis[st]=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">while</span>(!q.<span class="hljs-built_in">empty</span>())&#123;<br>			rint u=q.<span class="hljs-built_in">front</span>();q.<span class="hljs-built_in">pop</span>();vis[u]=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>				rint v=e[i].to;<br>				<span class="hljs-keyword">if</span>(e[i].val&amp;&amp;dis[v]&lt;dis[u]+e[i].cost)&#123;<br>					dis[v]=dis[u]+e[i].cost;<br>					pre[v]=i;<br>					<span class="hljs-keyword">if</span>(!vis[v])&#123;<br>						q.<span class="hljs-built_in">push</span>(v);<br>						vis[v]=<span class="hljs-number">1</span>;<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> dis[ed]!=dis[<span class="hljs-number">0</span>];<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getans</span><span class="hljs-params">()</span></span>&#123;<br>		rint res=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">while</span>(<span class="hljs-built_in">spfa</span>())&#123;<br>			rint Min=<span class="hljs-number">1e9</span>;<br>			<span class="hljs-keyword">for</span>(rint now=ed;now!=st;now=e[pre[now]^<span class="hljs-number">1</span>].to)<br>				Min=<span class="hljs-built_in">min</span>(Min,e[pre[now]].val);<br>			<span class="hljs-keyword">for</span>(rint now=ed;now!=st;now=e[pre[now]^<span class="hljs-number">1</span>].to)<br>				e[pre[now]].val-=Min,e[pre[now]^<span class="hljs-number">1</span>].val+=Min;<br>			res+=Min*dis[ed];<br>		&#125;<br>		<span class="hljs-keyword">return</span> res;<br>	&#125;<br>&#125;;<br><span class="hljs-type">char</span> s[<span class="hljs-number">10005</span>];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">readIn</span><span class="hljs-params">()</span></span>&#123;<br>	cin.<span class="hljs-built_in">getline</span>(s+<span class="hljs-number">1</span>,<span class="hljs-number">10000</span>);<br>	rint len=<span class="hljs-built_in">strlen</span>(s+<span class="hljs-number">1</span>),n=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>,v=<span class="hljs-number">0</span>;i&lt;=len;i++)&#123;<br>		<span class="hljs-keyword">if</span>(s[i]==<span class="hljs-string">&#x27; &#x27;</span>)&#123;<br>			x[++n]=v;<br>			v=<span class="hljs-number">0</span>;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(s[i]&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;s[i]&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)<br>			v=v*<span class="hljs-number">10</span>+s[i]-<span class="hljs-string">&#x27;0&#x27;</span>;<br>	&#125;<br>	cin.<span class="hljs-built_in">getline</span>(s+<span class="hljs-number">1</span>,<span class="hljs-number">10000</span>);<br>	len=<span class="hljs-built_in">strlen</span>(s+<span class="hljs-number">1</span>);n=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>,v=<span class="hljs-number">0</span>;i&lt;=len;i++)&#123;<br>		<span class="hljs-keyword">if</span>(s[i]==<span class="hljs-string">&#x27; &#x27;</span>)&#123;<br>			y[++n]=v;<br>			v=<span class="hljs-number">0</span>;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(s[i]&lt;=<span class="hljs-string">&#x27;9&#x27;</span>&amp;&amp;s[i]&gt;=<span class="hljs-string">&#x27;0&#x27;</span>)<br>			v=v*<span class="hljs-number">10</span>+s[i]-<span class="hljs-string">&#x27;0&#x27;</span>;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(rint i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">Ins</span>(x[i]+<span class="hljs-number">1</span>,y[i]+<span class="hljs-number">1</span>),<span class="hljs-built_in">Ins</span>(y[i]+<span class="hljs-number">1</span>,x[i]+<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">return</span> n+<span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-type">bool</span> vis[N];<br><span class="hljs-type">int</span> Maxd,f[N][N];<br>vector&lt;<span class="hljs-type">int</span>&gt; vec1[N],vec2[N],g[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(rint u,rint d,vector&lt;<span class="hljs-type">int</span>&gt; vec[])</span></span>&#123;<br>	vis[u]=<span class="hljs-number">1</span>;Maxd=<span class="hljs-built_in">max</span>(Maxd,d);vec[d].<span class="hljs-built_in">push_back</span>(u);g[u].<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(rint i=h[u];i;i=e[i].nxt)&#123;<br>		rint v=e[i].to;<br>		<span class="hljs-keyword">if</span>(vis[v])<span class="hljs-keyword">continue</span>;<br>		g[u].<span class="hljs-built_in">push_back</span>(v);<br>		<span class="hljs-built_in">dfs</span>(v,d+<span class="hljs-number">1</span>,vec);<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	rint n=<span class="hljs-built_in">readIn</span>(),res=<span class="hljs-number">0</span>,cnt=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(rint x=<span class="hljs-number">1</span>;x&lt;=n;x++)<br>	<span class="hljs-keyword">for</span>(rint y=<span class="hljs-number">1</span>;y&lt;=n;y++)&#123;<br>		<span class="hljs-keyword">if</span>(x==y)<span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">memset</span>(f,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(f));<br>		<span class="hljs-built_in">memset</span>(vis,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(vis));<br>		Maxd=<span class="hljs-number">0</span>;vis[y]=<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">dfs</span>(x,<span class="hljs-number">1</span>,vec1);<br>		<span class="hljs-built_in">dfs</span>(y,<span class="hljs-number">1</span>,vec2);<br>		<span class="hljs-keyword">for</span>(rint v1:vec1[Maxd])<span class="hljs-keyword">for</span>(rint v2:vec2[Maxd])<br>			f[v1][v2]=f[v2][v1]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(rint d=Maxd<span class="hljs-number">-1</span>;d;d--)&#123;<br>			<span class="hljs-keyword">for</span>(rint v1:vec1[d])<span class="hljs-keyword">for</span>(rint v2:vec2[d])&#123;<br>				Netflow::<span class="hljs-built_in">clear</span>();<br>				<span class="hljs-keyword">for</span>(rint s1:g[v1])&#123;<br>					Netflow::mp[s1]=++Netflow::cnt;<br>					Netflow::<span class="hljs-built_in">Ins</span>(Netflow::st,Netflow::cnt,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>					Netflow::<span class="hljs-built_in">Ins</span>(Netflow::cnt,Netflow::st,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>				&#125;<br>				<span class="hljs-keyword">for</span>(rint s2:g[v2])&#123;<br>					Netflow::mp[s2]=++Netflow::cnt;<br>					Netflow::<span class="hljs-built_in">Ins</span>(Netflow::cnt,Netflow::ed,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>					Netflow::<span class="hljs-built_in">Ins</span>(Netflow::ed,Netflow::cnt,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>				&#125;<br>				<span class="hljs-keyword">for</span>(rint s1:g[v1])<span class="hljs-keyword">for</span>(rint s2:g[v2])&#123;<br>					Netflow::<span class="hljs-built_in">Ins</span>(Netflow::mp[s1],Netflow::mp[s2],<span class="hljs-number">1</span>,f[s1][s2]);<br>					Netflow::<span class="hljs-built_in">Ins</span>(Netflow::mp[s2],Netflow::mp[s1],<span class="hljs-number">0</span>,-f[s1][s2]);<br>				&#125;<br>				f[v1][v2]=f[v2][v1]=Netflow::<span class="hljs-built_in">getans</span>()+<span class="hljs-number">1</span>;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(rint d=<span class="hljs-number">1</span>;d&lt;=Maxd;d++)<br>			vec1[d].<span class="hljs-built_in">clear</span>(),vec2[d].<span class="hljs-built_in">clear</span>();<br>		res=<span class="hljs-built_in">max</span>(res,f[x][y]);<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,res);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%9D%82%E9%A2%98/" class="category-chain-item">杂题</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%9D%82%E9%A2%98/">#杂题</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>杂题选做</div>
      <div>https://suzipei.github.io/2023/01/10/problem1/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Su_Zipei</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年1月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/02/01/intrecovery/" title="微积分复习">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">微积分复习</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/12/01/python/" title="python笔记">
                        <span class="hidden-mobile">python笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
